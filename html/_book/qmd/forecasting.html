<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.549">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Bayes, AI and Deep Learning - 19&nbsp; Forecasting</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../qmd/nn.html" rel="next">
<link href="../qmd/tree.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
</head><body class="nav-sidebar floating fullcontent"><div class="hidden">
<p><span class="math display">\[
\newcommand{\prob}[1]{\operatorname{P}\left(#1\right)}
\newcommand{\Var}[1]{\operatorname{Var}\left(#1\right)}
\newcommand{\sd}[1]{\operatorname{sd}\left(#1\right)}
\newcommand{\Cor}[1]{\operatorname{Corr}\left(#1\right)}
\newcommand{\Cov}[1]{\operatorname{Cov}\left(#1\right)}
\newcommand{\E}[1]{\operatorname{E}\left(#1\right)}
\newcommand{\defeq}{\overset{\text{\tiny def}}{=}}
\DeclareMathOperator*{\argmax}{arg\,max}
\DeclareMathOperator*{\argmin}{arg\,min}
\DeclareMathOperator*{\mini}{minimize}
\]</span></p>
</div>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>





<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../qmd/data.html">AI</a></li><li class="breadcrumb-item"><a href="../qmd/forecasting.html"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Forecasting</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Bayes, AI and Deep Learning</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Principles of Data Science</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Bayes</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/prob.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Probability and Uncertainty</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/bayes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Bayes Rule</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/dec.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Utility, Risk and Decisions</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/bl.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Bayesian Parameter Learning</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/ab.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">AB Testing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/hyp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Bayesian Hypothesis Testing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/sp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Stochastic Processes</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/gp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Gaussian Processes</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/rl.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Reinforcement Learning</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">AI</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Unreasonable Effectiveness of Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/pattern.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Pattern Matching</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/glm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Linear and Multiple Regression</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/logistic.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Calssification: Logistic Regression</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/theoryai.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Theory of AI</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/rct.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">RCT: Field vs Observational</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/select.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Model Selection</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/tree.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Tree Models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/forecasting.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Forecasting</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">Deep Learning</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/nn.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Neural Networks</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/dlopt.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Gradient Descent</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/arch.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Image Processing</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/ex.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">Exercises</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../qmd/data.html">AI</a></li><li class="breadcrumb-item"><a href="../qmd/forecasting.html"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Forecasting</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Forecasting</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>Time series data are everywhere, but time series modeling is a fairly specialized area within statistics and data science. This post describes the <code>bsts</code> software package, which makes it easy to fit some fairly sophisticated time series models with just a few lines of R code.</p>
<p>Time series data appear in a surprising number of applications, ranging from business, to the physical and social sciences, to health, medicine, and engineering. Forecasting (e.g.&nbsp;next month’s sales) is common in problems involving time series data, but explanatory models (e.g.&nbsp;finding drivers of sales) are also important. Time series data are having something of a moment in the tech blogs right now, with Facebook announcing their “Prophet” system for time series forecasting (<span class="citation" data-cites="seanj.taylor2017">Sean J. Taylor and Ben Letham (<a href="references.html#ref-seanj.taylor2017" role="doc-biblioref">2017</a>)</span>), and Google posting about its forecasting system in this blog (<span class="citation" data-cites="erictassone2017">Eric Tassone and Farzan Rohani (<a href="references.html#ref-erictassone2017" role="doc-biblioref">2017</a>)</span>).</p>
<p>This post summarizes the <code>bsts</code> R package, a tool for fitting Bayesian structural time series models. These are a widely useful class of time series models, known in various literatures as “structural time series,” “state space models,” “Kalman filter models,” and “dynamic linear models,” among others. Though the models need not be fit using Bayesian methods, they have a Bayesian flavor and the <code>bsts</code> package was built to use Bayesian posterior sampling.</p>
<p>The <code>bsts</code> package is open source. You can download it from CRAN with the R command <code>install.packages("bsts")</code>. It shares some features with Facebook and Google systems, but it was written with different goals in mind. The other systems were written to do “forecasting at scale,” a phrase that means something different in time series problems than in other corners of data science. The Google and Facebook systems focus on forecasting daily data into the distant future. The “scale” in question comes from having many time series to forecast, not from any particular time series being extraordinarily long. The bottleneck in both cases is the lack of analyst attention, so the systems aim to automate analysis as much as possible. The Facebook system accomplishes this using regularized regression, while the Google system works by averaging a large ensemble of forecasts. Both systems focus on daily data, and derive much of their efficiency through the careful treatment of holidays.</p>
<p>There are aspects of <code>bsts</code> which can be similarly automated, and a specifically configured version of <code>bsts</code> is a powerful member of the Google ensemble. However, <code>bsts</code> can also be configured for specific tasks by an analyst who knows whether the goal is short term or long term forecasting, whether or not the data are likely to contain one or more seasonal effects, and whether the goal is actually to fit an explanatory model, and not primarily to do forecasting at all.</p>
<p>The workhorse behind <code>bsts</code> is the structural time series model. These models are briefly described in the section Structural time series models. Then the software is introduced through a series of extended examples that focus on a few of the more advanced features of <code>bsts</code>. Example 1: <strong>Nowcasting</strong> includes descriptions of the local linear trend and seasonal state models, as well as spike and slab priors for regressions with large numbers of predictors. Example 2: <strong>Long term forecasting</strong> describes a situation where the local level and local linear trend models would be inappropriate. It offers a semilocal linear trend model as an alternative. Example 3: <strong>Recession modeling</strong> describes an model where the response variable is non-Gaussian. The goal in Example 3 is not to predict the future, but to control for serial dependence in an explanatory model that seeks to identify relevant predictor variables. A final section concludes with a discussion of other features in the package which we won’t have space (maybe “time” is a better word) to explore with fully fleshed out examples.</p>
<section id="structural-time-series-models" class="level2" data-number="19.1">
<h2 data-number="19.1" class="anchored" data-anchor-id="structural-time-series-models"><span class="header-section-number">19.1</span> Structural time series models</h2>
<p>A structural time series model is defined by two equations. The observation equation relates the observed data <span class="math inline">\(y_t\)</span> to a vector of latent variables <span class="math inline">\(\alpha_t\)</span> known as the “state.” <span class="math display">\[
y_t = Z_t^T\alpha_t + \epsilon_t.
\]</span></p>
<p>The transition equation describes how the latent state evolves through time. <span class="math display">\[
\alpha_{t+1} = T_t \alpha_t + R_t \eta_t.
\]</span></p>
<p>The error terms <span class="math inline">\(\epsilon_t\)</span> and <span class="math inline">\(\eta_t\)</span> are Gaussian and independent of everything else. The arrays <span class="math inline">\(Z_t\)</span> , <span class="math inline">\(T_t\)</span> and <span class="math inline">\(R_t\)</span> are structural parameters. They may contain parameters in the statistical sense, but often they simply contain strategically placed 0’s and 1’s indicating which bits of <span class="math inline">\(\alpha_t\)</span> are relevant for a particular computation. An example will hopefully make things clearer.</p>
<p>The simplest useful model is the “local level model,” in which the vector <span class="math inline">\(\alpha_t\)</span> is just a scalar <span class="math inline">\(\mu_t\)</span>. The local level model is a random walk observed in noise. <span class="math display">\[\begin{align*}
y_t = &amp;\mu_t + \epsilon_t\\
\mu_{t+1} = &amp;\mu_t + \eta_t.
\end{align*}\]</span> Here <span class="math inline">\(\alpha_t=\mu_t\)</span> , and <span class="math inline">\(Z_t\)</span> , <span class="math inline">\(T_t\)</span>, and <span class="math inline">\(R_t\)</span> all collapse to the scalar value 1. Similar to Bayesian hierarchical models for nested data, the local level model is a compromise between two extremes. The compromise is determined by variances of <span class="math inline">\(\epsilon_t \sim N(0,\sigma^2)\)</span> and <span class="math inline">\(\eta_t \sim N(0,\tau^2)\)</span>. If <span class="math inline">\(\tau^2=0\)</span> then <span class="math inline">\(\mu_t\)</span> is a constant, so the data are IID Gaussian noise. In that case the best estimator of <span class="math inline">\(y_{t+1}\)</span> is the mean of <span class="math inline">\(y_1,\ldots,y_t\)</span>. Conversely, if <span class="math inline">\(\sigma^2=0\)</span> then the data follow a random walk, in which case the best estimator of <span class="math inline">\(y_{t+1}\)</span> is <span class="math inline">\(y_t\)</span>. Notice that in one case the estimator depends on all past data (weighted equally) while in the other it depends only on the most recent data point, giving past data zero weight. If both variances are positive then the optimal estimator of <span class="math inline">\(y_{t+1}\)</span> winds up being “exponential smoothing,” where past data are forgotten at an exponential rate determined by the ratio of the two variances. Also notice that while the state in this model is Markov (i.e.&nbsp;it only depends on the previous state), the dependence among the observed data extends to the beginning of the series.</p>
<div>

</div>
<div class="cell quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-randomwalk-1" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-randomwalk-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="forecasting_files/figure-html/fig-randomwalk-1.png" class="img-fluid figure-img" width="384">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-randomwalk-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;19.1: Apple Adjusted Closing Price
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-randomwalk-2" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-randomwalk-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="forecasting_files/figure-html/fig-randomwalk-2.png" class="img-fluid figure-img" width="384">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-randomwalk-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;19.2: Apple Adjusted Closing Price
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<p>In the example above, one of the plots shows the price of the Apple stock from ‘2021-01-01’, to = 2022-12-31. The other plot is a sequence generated from a random walk model fitted to the Apple price data. Can you spot which one is which?</p>
<p>Structural time series models are useful because they are flexible and modular. The analyst chooses the structure of <span class="math inline">\(\alpha_t\)</span> based on things like whether short or long term predictions are more important, whether the data contains seasonal effects, and whether and how regressors are to be included. Many of these models are standard, and can be fit using a variety of tools, such as the <code>StructTS</code> function distributed with base R or one of several <code>R</code> packages for fitting these models (with the <code>dlm</code> package (<span class="citation" data-cites="petris2010">Petris (<a href="references.html#ref-petris2010" role="doc-biblioref">2010</a>)</span>, <span class="citation" data-cites="campagnoli2009">Campagnoli, Petrone, and Petris (<a href="references.html#ref-campagnoli2009" role="doc-biblioref">2009</a>)</span>) deserving special mention). The <code>bsts</code> package handles all the standard cases, but it also includes several useful extensions, described in the next few sections through a series of examples. Each example includes a mathematical description of the model and example <code>bsts</code> code showing how to work with the model using the <code>bsts</code> software. To keep things short, details about prior assumptions are largely avoided.</p>
<div id="exm-Nowcasting" class="theorem example">
<p><span class="theorem-title"><strong>Example 19.1 (Nowcasting)</strong></span> <span class="citation" data-cites="scott2014">S. Scott and Varian (<a href="references.html#ref-scott2014" role="doc-biblioref">2014</a>)</span> and <span class="citation" data-cites="scott2015">S. L. Scott and Varian (<a href="references.html#ref-scott2015" role="doc-biblioref">2015</a>)</span> used structural time series models to show how Google search data can be used to improve short term forecasts (“nowcasts”) of economic time series. Figure below shows the motivating data set from <span class="citation" data-cites="scott2014">S. Scott and Varian (<a href="references.html#ref-scott2014" role="doc-biblioref">2014</a>)</span>, which is also included with the <code>bsts</code> package. The data consist of the weekly initial claims for unemployment insurance in the US, as reported by the US Federal Reserve. Like many official statistics they are released with delay and subject to revision. At the end of the week, the economic activity determining these numbers has taken place, but the official numbers are not published until several days later. For economic decisions based on these and similar numbers, it would help to have an early forecast of the current week’s number as of the close of the week. Thus the output of this analysis is truly a “nowcast” of data that has already happened rather than a “forecast” of data that will happen in the future.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bsts)     <span class="co"># load the bsts package</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(iclaims)     <span class="co"># bring the initial.claims data into scope</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(initial.claims<span class="sc">$</span>iclaimsNSA, <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">ylab=</span><span class="st">"Unemployment claims (thousand)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-bsts" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-bsts-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="forecasting_files/figure-html/fig-bsts-1.png" class="img-fluid figure-img" style="width:70.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-bsts-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;19.3: Weekly initial claims for unemployment in the US.
</figcaption>
</figure>
</div>
</div>
</div>
<p>There are two sources of information about the current value <span class="math inline">\(y_t\)</span> in the initial claims series: past values <span class="math inline">\(y_{t-\tau}\)</span> describing the time series behavior of the series, and contemporaneous predictors <span class="math inline">\(x_t\)</span> from a data source which is correlated with <span class="math inline">\(y_t\)</span> , but which is available without the delay exhibited by <span class="math inline">\(y_t\)</span> . The time series structure shows an obvious trend (in which the financial and housing crises in 2008 - 2009 are apparent) as well as a strong annual seasonal pattern. The external data source explored by Scott and Varian was search data from Google trends with search queries such as “how to file for unemployment” having obvious relevance.</p>
<p>Scott and Varian modeled the data using a structural time series with three state components:</p>
<ul>
<li>trend <span class="math inline">\(\mu_t\)</span></li>
<li>seasonal pattern <span class="math inline">\(\tau_t\)</span><br>
</li>
<li>regression component <span class="math inline">\(\beta^Tx_t\)</span>.</li>
</ul>
<p>The model is <span class="math display">\[\begin{align*}
y_t = &amp; \mu_t + \tau_t + \beta^T x_t + \epsilon_t\\
\mu_{t+1} = &amp;\mu_t + \delta_t + \eta_{0t}\\
\delta_{t+1} = &amp;\delta_t + \eta_{1t}\\
\tau_{t+1} = &amp;-\sum_{s = 1}^{S-1}\tau_{t} + \eta_{2t}.
\end{align*}\]</span></p>
<p>The trend component looks similar to the local level model above, but it has an extra term <span class="math inline">\(\delta_t\)</span> . Notice that <span class="math inline">\(\delta_t\)</span> is the amount of extra <span class="math inline">\(\mu\)</span> you can expect as <span class="math inline">\(t\rightarrow t+1\)</span>, so it can be interpreted as the slope of the local linear trend. Slopes normally multiply some <span class="math inline">\(x\)</span> variable, but in this case <span class="math inline">\(x=\Delta t\)</span>, which omitted from the equation because it is always 1. The slope evolves according to a random walk, which makes the trend an integrated random walk with an extra drift term. The local linear trend is a better model than the local level model if you think the time series is trending in a particular direction and you want future forecasts to reflect a continued increase (or decrease) seen in recent observations. Whereas the local level model bases forecasts around the average value of recent observations, the local linear trend model adds in recent upward or downward slopes as well. As with most statistical models, the extra flexibility comes at the price of extra volatility.</p>
<p>The best way to understand the seasonal component <span class="math inline">\(\tau_t\)</span> is in terms of a regression with seasonal dummy variables. Suppose you had quarterly data, so that <span class="math inline">\(S=4\)</span>. You might include the annual seasonal cycle using 3 dummy variables, with one left out as a baseline. Alternatively, you could include all four dummy variables but constrain their coefficients to sum to zero. The seasonal state model takes the latter approach, but the constraint is that the <span class="math inline">\(S\)</span> most recent seasonal effects must sum to zero in expectation. This allows the seasonal pattern to slowly evolve. Scott and Varian described the annual cycle in the weekly initial claims data using a seasonal state component with <span class="math inline">\(S=52\)</span>. Of course weeks don’t neatly divide years, but given the small number of years for which Google data are available the occasional one-period seasonal discontinuity was deemed unimportant.</p>
<p>Let’s ignore the regression component for now and fit a <code>bsts</code> model with just the trend and seasonal components.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">AddLocalLinearTrend</span>(<span class="fu">list</span>(), initial.claims<span class="sc">$</span>iclaimsNSA)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">AddSeasonal</span>(ss, initial.claims<span class="sc">$</span>iclaimsNSA, <span class="at">nseasons =</span> <span class="dv">52</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>model1 <span class="ot">&lt;-</span> <span class="fu">bsts</span>(initial.claims<span class="sc">$</span>iclaimsNSA,<span class="at">state.specification =</span> ss,<span class="at">niter =</span> <span class="dv">1000</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The first thing to do when fitting a <code>bsts</code> model is to specify the contents of the latent state vector <span class="math inline">\(\alpha_t\)</span>. The <code>bsts</code> package offers a library of state models, which are included by adding them to a state specification (which is just a list with a particular format). The call to <code>AddLocalLinearTrend</code> above adds a local linear trend state component to an empty state specification (the <code>list()</code> in its first argument). The call to <code>AddSeasonal</code> adds a seasonal state component with 52 seasons to the state specification created on the previous line. The state vector <span class="math inline">\(\alpha_t\)</span> is formed by concatenating the state from each state model. Similarly, the vector <span class="math inline">\(Z_t\)</span> is formed by concatenating the <span class="math inline">\(Z\)</span> vectors from the two state models, while the matrices <span class="math inline">\(T_t\)</span> and <span class="math inline">\(R_t\)</span> are combined in block-diagonal fashion.</p>
<p>The state specification is passed as an argument to <code>bsts</code>, along with the data and the desired number of MCMC iterations. The model is fit using an MCMC algorithm, which in this example takes about 20 seconds to produce 1000 MCMC iterations. The returned object is a list (with class attribute <code>bsts</code>). You can see its contents by typing</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(model1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>##  [1] "sigma.obs"                  "sigma.trend.level"         
##  [3] "sigma.trend.slope"          "sigma.seasonal.52"         
##  [5] "final.state"                "state.contributions"       
##  [7] "one.step.prediction.errors" "log.likelihood"            
##  [9] "has.regression"             "state.specification"       
## [11] "prior"                      "timestamp.info"            
## [13] "model.options"              "family"                    
## [15] "niter"                      "original.series"</code></pre>
</div>
</div>
<p>The first few elements contain the MCMC draws of the model parameters. Most of the other elements are data structures needed by various S3 methods (<code>plot, print, predict</code>, etc.) that can be used with the returned object. MCMC output is stored in vectors (for scalar parameters) or arrays (for vector or matrix parameters) where the first index in the array corresponds to MCMC iteration number, and the remaining indices correspond to dimension of the deviate being drawn.</p>
<p>Most users won’t need to look inside the returned <code>bsts</code> object because standard tasks like plotting and prediction are available through familiar S3 methods. For example, there are several plot methods available.</p>
<div class="cell" data-layout-nrow="2">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar=</span><span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">4</span>,<span class="dv">2</span>,<span class="dv">0</span>))</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model1)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model1, <span class="st">"components"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-claims" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-claims-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-claims" style="flex-basis: 100.0%;justify-content: flex-start;">
<div id="fig-claims-1" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-claims-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="forecasting_files/figure-html/fig-claims-1.png" class="img-fluid figure-img" data-ref-parent="fig-claims" width="576">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-claims-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) Prediction
</figcaption>
</figure>
</div>
</div>
</div>
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-claims" style="flex-basis: 100.0%;justify-content: flex-start;">
<div id="fig-claims-2" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-claims-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="forecasting_files/figure-html/fig-claims-2.png" class="img-fluid figure-img" data-ref-parent="fig-claims" width="576">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-claims-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) Components
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-claims-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;19.4: Structural time series model for unemployment claims
</figcaption>
</figure>
</div>
</div>
<p>The <a href="#fig-claims-1" class="quarto-xref">Figure&nbsp;<span>19.4 (a)</span></a> above shows the Posterior distribution of model state. Blue circles are actual data points. The <a href="#fig-claims-2" class="quarto-xref">Figure&nbsp;<span>19.4 (b)</span></a> shows the individual state components. The plot looks fuzzy because it is showing the marginal posterior distribution at each time point.</p>
<p>The default plot method plots the posterior distribution of the conditional mean <span class="math inline">\(Z_t^T\alpha_t\)</span> given the full data <span class="math inline">\(y=y_1,\ldots,y_T\)</span>. Other plot methods can be accessed by passing a string to the plot function. For example, to see the contributions of the individual state components, pass the string “components” as a second argument, as shown above. Figure below shows the output of these two plotting functions. You can get a list of all available plots by passing the string <code>help</code> as the second argument.</p>
<p>To predict future values there is a <code>predict</code> method. For example, to predict the next 12 time points you would use the following commands.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar=</span><span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">4</span>,<span class="dv">0</span>,<span class="dv">0</span>))</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>pred1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(model1, <span class="at">horizon =</span> <span class="dv">12</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pred1, <span class="at">plot.original =</span> <span class="dv">156</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="forecasting_files/figure-html/predict1-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>The output of predict is an object of class <code>bsts.prediction</code>, which has its own <code>plot</code> method. The <code>plot.original = 156</code> argument says to plot the prediction along with the last 156 time points (3 years) of the original series.</p>
</div>
</section>
<section id="regression-with-spike-and-slab-priors" class="level2" data-number="19.2">
<h2 data-number="19.2" class="anchored" data-anchor-id="regression-with-spike-and-slab-priors"><span class="header-section-number">19.2</span> Regression with spike and slab priors</h2>
<p>Now let’s add a regression component to the model described above, so that we can use Google search data to improve the forecast. The <code>bsts</code> package only includes 10 search terms with the initial claims data set, to keep the package size small, but <span class="citation" data-cites="scott2014">S. Scott and Varian (<a href="references.html#ref-scott2014" role="doc-biblioref">2014</a>)</span> considered examples with several hundred predictor variables. When faced with large numbers of potential predictors it is important to have a prior distribution that induces sparsity. A spike and slab prior is a natural way to express a prior belief that most of the regression coefficients are exactly zero.</p>
<p>A spike and slab prior is a prior on a set of regression coefficients that assigns each coefficient a positive probability of being zero. Upon observing data, Bayes’ theorem updates the inclusion probability of each coefficient. When sampling from the posterior distribution of a regression model under a spike and slab prior, many of the simulated regression coefficients will be exactly zero. This is unlike the “lasso” prior (the Laplace, or double-exponential distribution), which yields MAP estimates at zero but where posterior simulations will be all nonzero. You can read about the mathematical details of spike and slab priors in <span class="citation" data-cites="scott2014">S. Scott and Varian (<a href="references.html#ref-scott2014" role="doc-biblioref">2014</a>)</span>.</p>
<p>When fitting <code>bsts</code> models that contain a regression component, extra arguments captured by <code>...</code> are passed to the SpikeSlabPrior function from the BoomSpikeSlab package. This allows the analyst to adjust the default prior settings for the regression component from the <code>bsts</code> function call. To include a regression component in a <code>bsts</code> model, simply pass a model formula as the first argument.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit a `bsts` model with expected model size 1, the default.</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>model2 <span class="ot">&lt;-</span> <span class="fu">bsts</span>(iclaimsNSA <span class="sc">~</span> .,<span class="at">state.specification =</span> ss,<span class="at">niter =</span> <span class="dv">1000</span>,<span class="at">data =</span> initial.claims)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit a `bsts` model with expected model size 5, to include more coefficients.</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>model3 <span class="ot">&lt;-</span> <span class="fu">bsts</span>(iclaimsNSA <span class="sc">~</span> .,<span class="at">state.specification =</span> ss,<span class="at">niter =</span> <span class="dv">1000</span>,<span class="at">data =</span> initial.claims,<span class="at">expected.model.size =</span> <span class="dv">5</span>)  <span class="co"># Passed to SpikeSlabPrior.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To examine the output you can use the same plotting functions as before. For example, to see the contribution of each state component you can type</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar=</span><span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">4</span>,<span class="dv">3</span>,<span class="dv">0</span>))</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model2, <span class="st">"comp"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="forecasting_files/figure-html/plotmodel2-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>It produces the contribution of each state component to the initial claims data, assuming a regression component with default prior. Compare to the previous model. The regression component is explaining a substantial amount of variation in the initial claims series.</p>
<p>There are also plotting functions that you can use to visualize the regression coefficients. The following commands plot posterior inclusion probabilities for predictors in the “initial claims” nowcasting example assuming an expected model size of 1 and 5.</p>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar=</span><span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>))</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model2, <span class="st">"coef"</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model3, <span class="st">"coef"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-model23" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-model23-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-model23" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-model23-1" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-model23-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="forecasting_files/figure-html/fig-model23-1.png" class="img-fluid figure-img" data-ref-parent="fig-model23" width="384">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-model23-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) Full
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-model23" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-model23-2" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-model23-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="forecasting_files/figure-html/fig-model23-2.png" class="img-fluid figure-img" data-ref-parent="fig-model23" width="384">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-model23-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) Sparse
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-model23-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;19.5: Variable Importance
</figcaption>
</figure>
</div>
<p>The search term “unemployment office” shows up with high probability in both models. Increasing the expected model size from 1 (the default) to 5 allows other variables into the model, though “Idaho unemployment” is the only one that shows up with high probability.</p>
<p>Those probabilities are calculated from the histogram of the samples of each <span class="math inline">\(\beta\)</span> calculated by the estimation algorithm (MCMC)</p>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar=</span><span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">4</span>,<span class="dv">0</span>,<span class="dv">0</span>))</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co"># unemployment.office</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(model3<span class="sc">$</span>coefficients[,<span class="dv">10</span>], <span class="at">breaks =</span> <span class="dv">40</span>, <span class="at">main=</span><span class="st">""</span>,<span class="at">xlab=</span><span class="st">"unemployment.office"</span>, <span class="at">col=</span><span class="st">"lightblue"</span>)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co"># pennsylvania.unemployment</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(model3<span class="sc">$</span>coefficients[,<span class="dv">3</span>], <span class="at">breaks =</span> <span class="dv">40</span>, <span class="at">main =</span> <span class="st">""</span>, <span class="at">xlab=</span><span class="st">"pennsylvania.unemployment"</span>, <span class="at">col=</span><span class="st">"lightblue"</span>)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(model2<span class="sc">$</span>coefficients[,<span class="dv">3</span>], <span class="at">breaks =</span> <span class="dv">40</span>, <span class="at">main =</span> <span class="st">""</span>, <span class="at">xlab=</span><span class="st">"pennsylvania.unemployment"</span>, <span class="at">col=</span><span class="st">"lightblue"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-bstshist" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-bstshist-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-bstshist" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-bstshist-1" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-bstshist-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="forecasting_files/figure-html/fig-bstshist-1.png" class="img-fluid figure-img" data-ref-parent="fig-bstshist" width="384">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-bstshist-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) Sparse
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-bstshist" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-bstshist-2" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-bstshist-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="forecasting_files/figure-html/fig-bstshist-2.png" class="img-fluid figure-img" data-ref-parent="fig-bstshist" width="384">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-bstshist-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) Sparse
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-bstshist" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-bstshist-3" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-bstshist-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="forecasting_files/figure-html/fig-bstshist-3.png" class="img-fluid figure-img" data-ref-parent="fig-bstshist" width="384">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-bstshist-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(c) Full
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-bstshist-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;19.6: Sample from the distribution over two beta parameters
</figcaption>
</figure>
</div>
</section>
<section id="model-diagnostics-did-the-google-data-help" class="level2" data-number="19.3">
<h2 data-number="19.3" class="anchored" data-anchor-id="model-diagnostics-did-the-google-data-help"><span class="header-section-number">19.3</span> Model diagnostics: Did the Google data help?</h2>
<p>As part of the model fitting process, the algorithm generates the one-step-ahead prediction errors <span class="math inline">\(y_t - E(y_t | Y_{t-1}, \theta)\)</span>, where <span class="math inline">\(Y_{t-1}=y_1,\ldots,y_{t-1}\)</span>, and the vector of model parameters <span class="math inline">\(\theta\)</span> is fixed at its current value in the MCMC algorithm. The one-step-ahead prediction errors can be obtained from the <code>bsts</code> model by calling <code>bsts.prediction.errors(model1)</code>.</p>
<p>The one step prediction errors are a useful diagnostic for comparing several <code>bsts</code> models that have been fit to the same data. They are used to implement the function <code>CompareBstsModels</code>, which is called as shown below.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">CompareBstsModels</span>(<span class="fu">list</span>(<span class="st">"Model 1"</span> <span class="ot">=</span> model1,</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>               <span class="st">"Model 2"</span> <span class="ot">=</span> model2,</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>               <span class="st">"Model 3"</span> <span class="ot">=</span> model3),</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">colors =</span> <span class="fu">c</span>(<span class="st">"black"</span>, <span class="st">"red"</span>, <span class="st">"blue"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="forecasting_files/figure-html/compareRUE-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></p>
<figcaption>Comparison of Errors for the three models.</figcaption>
</figure>
</div>
</div>
</div>
<p>The bottom panel shows the original series. The top panel shows the cumulative total of the mean absolute one step prediction errors for each model. The final time point in the top plot is proportional to the mean absolute prediction error for each model, but plotting the errors as a cumulative total lets you see particular spots where each model encountered trouble, rather than just giving a single number describing each model’s predictive accuracy. This figure shows that the Google data help explain the large spike near 2009, where model 1 accumulates errors at an accelerated rate, but models 2 and 3 continue accumulating errors at about the same rate they had been before. The fact that the lines for models 2 and 3 overlap in this figure means that the additional predictors allowed by the relaxed prior used to fit model 3 do not yield additional predictive accuracy.</p>
<div id="exm-LongTermForecasting" class="theorem example">
<p><span class="theorem-title"><strong>Example 19.2 (Long term forecasting)</strong></span> A common question about <code>bsts</code> is “which trend model should I use?” To answer that question it helps to know a bit about the different models that the <code>bsts</code> software package provides, and what each model implies. In the local level model the state evolves according to a random walk: <span class="math display">\[
\mu_{t+1}=\mu_t+\eta_t.
\]</span> If you place your eye at time 0 and ask what happens at time <span class="math inline">\(t\)</span> , you find that <span class="math inline">\(\mu_t \sim N(\mu_0,t\sigma^2\eta)\)</span>. The variance continues to grow with <span class="math inline">\(t\)</span>, all the way to <span class="math inline">\(t=\infty\)</span>. The local linear trend is even more volatile. When forecasting far into the future the flexibility provided by these models becomes a double edged sword, as local flexibility in the near term translates into extreme variance in the long term.</p>
<p>An alternative is to replace the random walk with a stationary AR process. For example <span class="math display">\[
\mu_{t+1}=\rho\mu_t+\eta_t,
\]</span></p>
<p>with <span class="math inline">\(\eta_t \sim N(0,\sigma^2\eta)\)</span> and <span class="math inline">\(|\rho|&lt;1\)</span>. This model has stationary distribution <span class="math display">\[
\mu_{\infty} \sim N\left(0,\dfrac{\sigma^2_{\eta}}{1-\rho^2}\right),
\]</span> which means that uncertainty grows to a finite asymptote, rather than infinity, in the distant future. <code>bsts</code> offers autoregressive state models through the functions <code>AddAr</code>, when you want to specify a certain number of lags, and <code>AddAutoAr</code> when you want the software to choose the important lags for you.</p>
<p>A hybrid model modifies the local linear trend model by replacing the random walk on the slope with a stationary AR(1) process, while keeping the random walk for the level of the process. The <code>bsts</code> package refers to this is the “semilocal linear trend” model. <span class="math display">\[\begin{align*}
\mu_{t+1}=&amp;    \mu_t+\delta_t+\eta_{0t}\\
\delta_{t+1}=&amp; D+\rho(\delta_t-D)+\eta_{1t}
\end{align*}\]</span> The <span class="math inline">\(D\)</span> parameter is the long run slope of the trend component, to which <span class="math inline">\(\delta_t\)</span> will eventually revert. However <span class="math inline">\(\delta_t\)</span> can have short term autoregressive deviations from the long term trend, with memory determined by <span class="math inline">\(\rho\)</span>. Values of <span class="math inline">\(\rho\)</span> close to 1 will lead to long deviations from <span class="math inline">\(D\)</span>. To see the impact this can have on long term forecasts, consider the time series of daily closing values for the S&amp;P 500 stock market index over the last 5 years, shown below.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>GSPC <span class="ot">=</span> <span class="fu">read.csv</span>(<span class="st">"../../data/GSPC.csv"</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>GSPC <span class="ot">=</span> <span class="fu">xts</span>(GSPC, <span class="at">order.by =</span> <span class="fu">as.Date</span>(<span class="fu">rownames</span>(GSPC), <span class="st">"%Y-%m-%d"</span>))</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="fu">head</span>(GSPC))</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(GSPC<span class="sc">$</span>GSPC.Adjusted, <span class="at">main=</span><span class="st">""</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="forecasting_files/figure-html/sp500-1.png" class="img-fluid figure-img" style="width:70.0%"></p>
<figcaption>Daily closing values for the S&amp;P 500 stock market index</figcaption>
</figure>
</div>
</div>
</div>
<p>Consider two forecasts of the daily values of this series for the next 360 days. The first assumes the local linear trend model. The second assumes the semilocal linear trend.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>sp500 <span class="ot">=</span> GSPC<span class="sc">$</span>GSPC.Adjusted</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>ss1 <span class="ot">&lt;-</span> <span class="fu">AddLocalLinearTrend</span>(<span class="fu">list</span>(), sp500)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>model1 <span class="ot">&lt;-</span> <span class="fu">bsts</span>(sp500, <span class="at">state.specification =</span> ss1, <span class="at">niter =</span> <span class="dv">1000</span>)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>ss2 <span class="ot">&lt;-</span> <span class="fu">AddSemilocalLinearTrend</span>(<span class="fu">list</span>(), sp500)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>model2 <span class="ot">&lt;-</span> <span class="fu">bsts</span>(sp500, <span class="at">state.specification =</span> ss2, <span class="at">niter =</span> <span class="dv">1000</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Figure below shows long term forecasts of the S&amp;P 500 closing values under the (left) local linear trend and (right) semilocal linear trend state models.</p>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"../../data/timeseries/model12-sp500.RData"</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar=</span><span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">4</span>,<span class="dv">0</span>,<span class="dv">1</span>))</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>pred1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(model1, <span class="at">horizon =</span> <span class="dv">360</span>)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>pred2 <span class="ot">&lt;-</span> <span class="fu">predict</span>(model2, <span class="at">horizon =</span> <span class="dv">360</span>)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pred2, <span class="at">plot.original =</span> <span class="dv">360</span>, <span class="at">ylim =</span> <span class="fu">range</span>(pred1))</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pred1, <span class="at">plot.original =</span> <span class="dv">360</span>, <span class="at">ylim =</span> <span class="fu">range</span>(pred1))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-sp500" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-sp500-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-sp500" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-sp500-1" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-sp500-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="forecasting_files/figure-html/fig-sp500-1.png" class="img-fluid figure-img" data-ref-parent="fig-sp500" width="384">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-sp500-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) Semi-local trend
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-sp500" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-sp500-2" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-sp500-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="forecasting_files/figure-html/fig-sp500-2.png" class="img-fluid figure-img" data-ref-parent="fig-sp500" width="384">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-sp500-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) Local trend
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-sp500-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;19.7: S&amp;P 500 Prediction
</figcaption>
</figure>
</div>
<p>Not only the forecast expectations from the two models are different, but the forecast errors from the local linear trend model are implausibly wide, including a small but nonzero probability that the S&amp;P 500 index could close near zero in the next 360 days. The error bars from the semilocal linear trend model are far more plausible, and more closely match the uncertainty observed over the life of the series thus far.</p>
</div>
<div id="exm-Recession" class="theorem example">
<p><span class="theorem-title"><strong>Example 19.3 (Recession modeling using non-Gaussian data)</strong></span> Although we have largely skipped details about how the <code>bsts</code> software fits models, the Gaussian error assumptions in the observation and transition equations are important for the model fitting process. Part of that process involves running data through the Kalman filter, which assumes Gaussian errors in both the state and transition equations. In many settings where Gaussian errors are obviously inappropriate, such as for binary or small count data, one can introduce latent variables that give the model a conditionally Gaussian representation. Well known “data augmentation” methods exist for probit regression (<span class="citation" data-cites="albert1993a">Albert (<a href="references.html#ref-albert1993a" role="doc-biblioref">1993</a>)</span>) and models with student-T errors (<span class="citation" data-cites="rubin2015">Rubin (<a href="references.html#ref-rubin2015" role="doc-biblioref">2015</a>)</span>). Somewhat more complex methods exist for logistic regression (<span class="citation" data-cites="fruhwirth-schnatter2007">Frühwirth-Schnatter and Frühwirth (<a href="references.html#ref-fruhwirth-schnatter2007" role="doc-biblioref">2007</a>)</span>, <span class="citation" data-cites="held2006">Held and Holmes (<a href="references.html#ref-held2006" role="doc-biblioref">2006</a>)</span>, <span class="citation" data-cites="gramacy2012">Gramacy and Polson (<a href="references.html#ref-gramacy2012" role="doc-biblioref">2012</a>)</span>) and Poisson regression (<span class="citation" data-cites="fruhwirth-schnatter2008">Frühwirth-Schnatter et al. (<a href="references.html#ref-fruhwirth-schnatter2008" role="doc-biblioref">2008</a>)</span>). Additional methods exist for quantile regression (<span class="citation" data-cites="benoit2012">Benoit and Van den Poel (<a href="references.html#ref-benoit2012" role="doc-biblioref">2012</a>)</span>), support vector machines (<span class="citation" data-cites="polson2011">Polson and Scott (<a href="references.html#ref-polson2011" role="doc-biblioref">2011</a>)</span>), and multinomial logit regression (<span class="citation" data-cites="fruhwirth-schnatter2010">Frühwirth-Schnatter and Frühwirth (<a href="references.html#ref-fruhwirth-schnatter2010" role="doc-biblioref">2010</a>)</span>). These are not currently provided by the <code>bsts</code> package, but they might be added in the future.</p>
<p>To see how non-Gaussian errors can be useful, consider the analysis done by <span class="citation" data-cites="berge2016">Berge, Sinha, and Smolyansky (<a href="references.html#ref-berge2016" role="doc-biblioref">2016</a>)</span> who used Bayesian model averaging (BMA) to investigate which of several economic indicators would best predict the presence or absence of a recession. We will focus on their nowcasting example, which models the probability of a recession at the same time point as the predictor variables. <span class="citation" data-cites="berge2016">Berge, Sinha, and Smolyansky (<a href="references.html#ref-berge2016" role="doc-biblioref">2016</a>)</span> also analyzed the data with the predictors at several lags.</p>
<p>The model used in <span class="citation" data-cites="berge2016">Berge, Sinha, and Smolyansky (<a href="references.html#ref-berge2016" role="doc-biblioref">2016</a>)</span> was a probit regression, with Bayesian model averaging used to determine which predictors should be included. The response variable was the the presence or absence of a recession (as determined by NBER).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"../../data/timeseries/rec_data_20160613.csv"</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>rec <span class="ot">=</span> <span class="fu">ts</span>(dat<span class="sc">$</span>nber, <span class="at">start=</span><span class="fu">c</span>(<span class="dv">1973</span>, <span class="dv">1</span>), <span class="at">end=</span><span class="fu">c</span>(<span class="dv">2016</span>, <span class="dv">5</span>), <span class="at">frequency=</span><span class="dv">12</span>)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(rec, <span class="at">type=</span><span class="st">'l'</span>, <span class="at">col=</span><span class="st">'blue'</span>, <span class="at">ylab=</span><span class="st">"Recession"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="forecasting_files/figure-html/nber-1.png" class="img-fluid figure-img" width="576"></p>
<figcaption>Recession periods identified by NBER</figcaption>
</figure>
</div>
</div>
</div>
<p>The BMA done by <span class="citation" data-cites="berge2016">Berge, Sinha, and Smolyansky (<a href="references.html#ref-berge2016" role="doc-biblioref">2016</a>)</span> is essentially the same as fitting a logistic regression under a spike-and-slab prior with the prior inclusion probability of each predictor set to 1/2 . That analysis can be run using the BoomSpikeSlab R package (<span class="citation" data-cites="scott2022">S. L. Scott (<a href="references.html#ref-scott2022" role="doc-biblioref">2022</a>)</span>), which is similar to <code>bsts</code>, but with only a regression component and no time series.</p>
<p>The logistic regression model is highly predictive, but it ignores serial dependence in the data. To capture serial dependence, consider the following dynamic logistic regression model with a local level trend model. <span class="math display">\[\begin{align*}
\mathrm{logit}(p_t)= &amp;  \mu_t+\beta^Tx_t\\
\mu_{t+1}= &amp;            \mu_t+\eta_t
\end{align*}\]</span> Here <span class="math inline">\(p_t\)</span> is the probability of a recession at time <span class="math inline">\(t\)</span> ,and <span class="math inline">\(x_t\)</span> is the set of economic indicators used by <span class="citation" data-cites="berge2016">Berge, Sinha, and Smolyansky (<a href="references.html#ref-berge2016" role="doc-biblioref">2016</a>)</span> in their analysis. The variables are listed in the table below</p>
<table class="table">
<colgroup>
<col style="width: 37%">
<col style="width: 42%">
<col style="width: 20%">
</colgroup>
<thead>
<tr class="header">
<th>Variable</th>
<th>Definition/notes</th>
<th>Transformation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Financial Variables</strong></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>Slope of yield curve</td>
<td>10-year Treasury less 3-month yield</td>
<td></td>
</tr>
<tr class="odd">
<td>Curvature of yield curve</td>
<td>2 x 2-year minus 3-month and 10-year</td>
<td></td>
</tr>
<tr class="even">
<td>GZ index</td>
<td>Gilchrist and Zakrajsek (AER, 2012)</td>
<td></td>
</tr>
<tr class="odd">
<td>TED spread</td>
<td>3-month ED less 3-month Treasury yield</td>
<td></td>
</tr>
<tr class="even">
<td>BBB corporate spread</td>
<td>BBB less 10-year Treasury yield</td>
<td></td>
</tr>
<tr class="odd">
<td>S 500, 1-month return</td>
<td></td>
<td>1-month log diff.</td>
</tr>
<tr class="even">
<td>S 500, 3-month return</td>
<td></td>
<td>3-month log diff.</td>
</tr>
<tr class="odd">
<td>Trade-weighted dollar</td>
<td></td>
<td>3-month log diff.</td>
</tr>
<tr class="even">
<td>VIX</td>
<td>CBOE and extended following Bloom</td>
<td></td>
</tr>
<tr class="odd">
<td><strong>Macroeconomic Indicators</strong></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>Real personal consumption expend.</td>
<td></td>
<td>3-month log diff.</td>
</tr>
<tr class="odd">
<td>Real disposable personal income</td>
<td></td>
<td>3-month log diff.</td>
</tr>
<tr class="even">
<td>Industrial production</td>
<td></td>
<td>3-month log diff.</td>
</tr>
<tr class="odd">
<td>Housing permits</td>
<td></td>
<td>3-month log diff.</td>
</tr>
<tr class="even">
<td>Nonfarm payroll employment</td>
<td></td>
<td>3-month log diff.</td>
</tr>
<tr class="odd">
<td>Initial claims</td>
<td>4-week moving average</td>
<td>3-month log diff.</td>
</tr>
<tr class="even">
<td>Weekly hours, manufacturing</td>
<td></td>
<td>3-month log diff.</td>
</tr>
<tr class="odd">
<td>Purchasing managers index</td>
<td></td>
<td>3-month log dif</td>
</tr>
</tbody>
</table>
<p>First, we prepare the data by shifting it by <span class="math inline">\(h\)</span>, which is the forecast horison.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>h<span class="ot">=</span><span class="dv">0</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="co"># predict h months ahead</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>y.h <span class="ot">&lt;-</span> dat<span class="sc">$</span>nber[<span class="sc">-</span>(<span class="dv">1</span><span class="sc">:</span>h)]</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>hh <span class="ot">&lt;-</span> <span class="fu">length</span>(dat<span class="sc">$</span>nber) <span class="sc">-</span> h</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>dat.h <span class="ot">&lt;-</span> dat[<span class="dv">1</span><span class="sc">:</span>hh,<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="co"># h=0 is a special case</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(h<span class="sc">==</span><span class="dv">0</span>) y.h   <span class="ot">&lt;-</span> dat<span class="sc">$</span>nber</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(h<span class="sc">==</span><span class="dv">0</span>) dat.h <span class="ot">&lt;-</span> dat[,<span class="sc">-</span><span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To fit this model, we can issue the commands shown below.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Because 'y' is 0/1 and the state is on the logit scale the default prior</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="co"># assumed by AddLocalLevel won't work here, so we need to explicitly set the</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co"># priors for the variance of the state innovation errors and the initial value</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co"># of the state at time 0.  The 'SdPrior' and 'NormalPrior' functions used to</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="co"># define these priors are part of the Boom package.  See R help for</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="co"># documentation.  Note the truncated support for the standard deviation of the</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="co"># random walk increments in the local level model.</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="co"># A more complex model</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">AddLocalLevel</span>(<span class="fu">list</span>(),y.h,</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>                    <span class="at">sigma.prior =</span> <span class="fu">SdPrior</span>(<span class="at">sigma.guess =</span> .<span class="dv">1</span>,</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">sample.size =</span> <span class="dv">1</span>,</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">upper.limit =</span> <span class="dv">1</span>),</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>                    <span class="at">initial.state.prior =</span> <span class="fu">NormalPrior</span>(<span class="dv">0</span>, <span class="dv">5</span>))</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Tell bsts that the observation equation should be a logistic regression by</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="co"># passing the 'family = "logit"' argument.</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>ts.model <span class="ot">&lt;-</span> <span class="fu">bsts</span>(y.h <span class="sc">~</span> ., ss, <span class="at">data =</span> dat.h, <span class="at">niter =</span> <span class="dv">20000</span>,<span class="at">family =</span> <span class="st">"logit"</span>, <span class="at">expected.model.size =</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Not let’s plot the results</p>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar=</span><span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">4</span>,<span class="dv">0</span>,<span class="dv">0</span>))</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ts.model,<span class="st">"coef"</span>)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ts.model)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(y.h, <span class="at">lwd=</span><span class="dv">3</span>,<span class="at">col=</span><span class="st">"blue"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<p><img src="forecasting_files/figure-html/nber-plot-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<p><img src="forecasting_files/figure-html/nber-plot-2.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ts.model,<span class="st">"predictors"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="forecasting_files/figure-html/ts.model-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Notice, the distribution of <span class="math inline">\(p_t\)</span>, it is moving to very large values during a recession, and to very small values outside of a recession. This effect captures the strong serial dependence in the recession data. Recessions are rare, but once they occur they tend to persist. Assuming independent time points is therefore unrealistic, and it substantially overstates the amount of information available to identify logistic regression coefficients.</p>
</div>
</section>
<section id="final-remarks-on-structural-models" class="level2" data-number="19.4">
<h2 data-number="19.4" class="anchored" data-anchor-id="final-remarks-on-structural-models"><span class="header-section-number">19.4</span> Final Remarks on Structural Models</h2>
<p>The preceding examples have shown that the <code>bsts</code> software package can handle several nonstandard, but useful, time series applications. These include the ability to handle large numbers of contemporaneous predictors with spike and slab priors, the presence of trend models suitable for long term forecasting, and the ability to handle non-Gaussian data. We have run out of space, but <code>bsts</code> can do much more.</p>
<p>For starters there are other state models you can use. Bsts has elementary support for holidays. It knows about 18 US holidays, and has capacity to add more, including holidays that occur on the same date each year, holidays that occur on a fixed weekday of a fixed month (e.g.&nbsp;3rd Tuesday in February, or last Monday in November). The model for each holiday is a simple random walk, but look for future versions to have improved holiday support via Bayesian shrinkage.</p>
<p>Bsts offers support for multiple seasonalities. For example, if you have several weeks of hourly data then you will have an hour-of-day effect as well as a day-of-week effect. You can model these using a single seasonal effect with 168 seasons (which would allow for different hourly effects on weekends and weekdays), or you can assume additive seasonal patterns using the season.duration argument to <code>AddSeasonal</code>,</p>
<pre><code>ss &lt;- AddSeasonal(ss, y, nseasons = 24)
ss &lt;- AddSeasonal(ss, y, nseasons = 7, season.duration = 24)</code></pre>
<p>The latter specifies that each daily effect should remain constant for 24 hours. For modeling physical phenomena, <code>bsts</code> also offers trigonometric seasonal effects, which are sine and cosine waves with time varying coefficients. You obtain these by calling AddTrig. Time varying effects are available for arbitrary regressions with small numbers of predictor variables through a call to <code>AddDynamicRegression</code>.</p>
<p>In addition to the trend models discussed so far, the function <code>AddStudentLocalLinearTrend</code> gives a version of the local linear trend model that assumes student-t errors instead of Gaussian errors. This is a useful state model for short term predictions when the mean of the time series exhibits occasional dramatic jumps. Student-t errors can be introduced into the observation equation by passing the <code>family = "student"</code> argument to the <code>bsts</code> function call. Allowing for heavy tailed errors in the observation equation makes the model robust against individual outliers, while heavy tails in the state model provides robustness against sudden persistent shifts in level or slope. This can lead to tighter prediction limits than Gaussian models when modeling data that have been polluted by outliers. The observation equation can also be set to a Poisson model for small count data if desired.</p>
<p>Finally, the most recent update to <code>bsts</code> supports data with multiple observations at each time stamp. The Gaussian version of the model is <span class="math display">\[\begin{align*}
y_{it} = &amp;\beta^T x_{it} + Z_t^T\alpha_t + \epsilon_{it}\\
\alpha_{t+1} = &amp; T_t \alpha_t + R_t \eta_t,
\end{align*}\]</span> which is best understood as a regression model with a time varying intercept.</p>
</section>
<section id="modern-era-forecasting" class="level2" data-number="19.5">
<h2 data-number="19.5" class="anchored" data-anchor-id="modern-era-forecasting"><span class="header-section-number">19.5</span> Modern Era Forecasting</h2>
<p>A recent post by the Amazon Science group <span class="citation" data-cites="amazon2021">Amazon (<a href="references.html#ref-amazon2021" role="doc-biblioref">2021</a>)</span> describes the evolution of the time series algorithms used for forecasting from 2007 to 2021. Figure below shows the entire evolution of the algorithms.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../fig/amazon.jpeg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:60.0%"></p>
</figure>
</div>
<p>They went from standard textbook time series forecasting methods to make predictions to the quantile-based transformer models. The main problem of the traditional TS models is that they assume stationary. A stationary time series is one whose properties do not depend on the time at which the series is observed. For exmaple, a white noise series is stationary — it does not matter when you observe it, it should look much the same at any point in time.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>yt <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="dv">100</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(yt,<span class="at">type=</span><span class="st">'l'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="forecasting_files/figure-html/whitenoise-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:60.0%"></p>
</figure>
</div>
</div>
</div>
<p>In other words, all the coefficients of a time series model do not change over time. We know how to deal with trends and seasonality quite well. Thus, those types of non-stationary are not an issue. Below some of the example of time series data. Although most of those are not stationary, we can model them using traditional techniques (<span class="citation" data-cites="hyndman2021">Hyndman and Athanasopoulos (<a href="references.html#ref-hyndman2021" role="doc-biblioref">2021</a>)</span>).</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-stationary" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-stationary-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="forecasting_files/figure-html/fig-stationary-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-stationary-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;19.8: Which of these series are stationary? (a) Dow Jones index on 292 consecutive days; (b) Daily change in the Dow Jones index on 292 consecutive days; (c) Annual number of strikes in the US; (d) Monthly sales of new one-family houses sold in the US; (e) Annual price of a dozen eggs in the US (constant dollars); (f) Monthly total of pigs slaughtered in Victoria, Australia; (g) Annual total of lynx trapped in the McKenzie River district of north-west Canada; (h) Monthly Australian beer production; (i) Monthly Australian electricity production.
</figcaption>
</figure>
</div>
</div>
</div>
<p>However, when you try to forecast for a time series with no prior history or non-recurrent “jumps”, like recessions, traditional models are unlikely to work well.</p>
<p>Amazon used a sequence of “patches” to hack the model and to make it produce useful results. All of those reacquired manual feature engineering and led to less transparent and fragile models. One solution is to use random forests.</p>
</section>
<section id="quantile-regression-forests." class="level2" data-number="19.6">
<h2 data-number="19.6" class="anchored" data-anchor-id="quantile-regression-forests."><span class="header-section-number">19.6</span> Quantile Regression Forests.</h2>
<p>Most estimators during prediction return <span class="math inline">\(E(Y|X)\)</span>, which can be interpreted as the answer to the question, what is the expected value of your output given the input?</p>
<p>Quantile methods, return <span class="math inline">\(y\)</span> at <span class="math inline">\(q\)</span> for which <span class="math inline">\(F(Y=y|X)=q\)</span> where <span class="math inline">\(q\)</span> is the percentile and <span class="math inline">\(y\)</span> is the quantile. One quick use-case where this is useful is when there are a number of outliers which can influence the conditional mean. It is sometimes important to obtain estimates at different percentiles, (when grading on a curve is done for instance.)</p>
<p>Note, Bayesian models return the entire distribution of <span class="math inline">\(P(Y|X)\)</span>.</p>
<p>It is fairly straightforward to extend a standard decision tree to provide predictions at percentiles. When a decision tree is fit, the trick is to store not only the sufficient statistics of the target at the leaf node such as the mean and variance but also all the target values in the leaf node. At prediction, these are used to compute empirical quantile estimates.</p>
<p>The same approach can be extended to Random Forests. To estimate <span class="math inline">\(F(Y=y|x)=q\)</span> each target value in training <span class="math inline">\(y\)</span>s is given a weight. Formally, the weight given to <span class="math inline">\(y_j\)</span> while estimating the quantile is <span class="math display">\[
\frac{1}{T} \sum_{t=1}^{T} \frac{\mathbb{1}(y_j \in L(x))}{\sum_{i=1}^N \mathbb{1}(y_i \in L(x))},
\]</span> where <span class="math inline">\(L(x)\)</span> denotes the leaf that <span class="math inline">\(x\)</span> falls into.</p>
<p>Informally, what it means that for a new unknown sample, we first find the leaf that it falls into at each tree. Then for each <span class="math inline">\((X, y)\)</span> in the training data, a weight is given to <span class="math inline">\(y\)</span> at each tree in the following manner.</p>
<ol type="1">
<li>If it is in the same leaf as the new sample, then the weight is the fraction of samples in the same leaf.</li>
<li>If not, then the weight is zero.</li>
</ol>
<p>These weights for each y are summed up across all trees and averaged. Now since we have an array of target values and an array of weights corresponding to these target values, we can use this to measure empirical quantile estimates.nding to these target values, we can use this to measure empirical quantile estimates.</p>
<p>Motivated by the success of gradient boositg model for predicting Walmart sales (<span class="citation" data-cites="kaggle2020">kaggle (<a href="references.html#ref-kaggle2020" role="doc-biblioref">2020</a>)</span>), <span class="citation" data-cites="januschowski2022">Januschowski et al. (<a href="references.html#ref-januschowski2022" role="doc-biblioref">2022</a>)</span> tries to explain why tree-based methods were so widely used for forecasting.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../fig/tree.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
<figcaption><span class="citation" data-cites="januschowski2022">Januschowski et al. (<a href="references.html#ref-januschowski2022" role="doc-biblioref">2022</a>)</span></figcaption>
</figure>
</div>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-albert1993a" class="csl-entry" role="listitem">
Albert, Jim. 1993. <span>“A <span>Statistical Analysis</span> of <span>Hitting Streaks</span> in <span>Baseball</span>: <span>Comment</span>.”</span> <em>Journal of the American Statistical Association</em> 88 (424): 1184–88. <a href="https://www.jstor.org/stable/2291255">https://www.jstor.org/stable/2291255</a>.
</div>
<div id="ref-amazon2021" class="csl-entry" role="listitem">
Amazon. 2021. <span>“The History of <span>Amazon</span>’s Forecasting Algorithm.”</span> <em>Amazon Science</em>. https://www.amazon.science/latest-news/the-history-of-amazons-forecasting-algorithm.
</div>
<div id="ref-benoit2012" class="csl-entry" role="listitem">
Benoit, Dries F., and Dirk Van den Poel. 2012. <span>“Binary Quantile Regression: A <span>Bayesian</span> Approach Based on the Asymmetric <span>Laplace</span> Distribution.”</span> <em>Journal of Applied Econometrics</em> 27 (7): 1174–88.
</div>
<div id="ref-berge2016" class="csl-entry" role="listitem">
Berge, Travis, Nitish Sinha, and Michael Smolyansky. 2016. <span>“Which <span>Market Indicators Best Forecast Recessions</span>?”</span> <em>FEDS Notes</em>, August.
</div>
<div id="ref-campagnoli2009" class="csl-entry" role="listitem">
Campagnoli, Patrizia, Sonia Petrone, and Giovanni Petris. 2009. <em>Dynamic <span>Linear Models</span> with <span>R</span></em>. <span>New York, NY</span>: <span>Springer</span>.
</div>
<div id="ref-erictassone2017" class="csl-entry" role="listitem">
Eric Tassone, and Farzan Rohani. 2017. <span>“Our Quest for Robust Time Series Forecasting at Scale.”</span>
</div>
<div id="ref-fruhwirth-schnatter2007" class="csl-entry" role="listitem">
Frühwirth-Schnatter, Sylvia, and Rudolf Frühwirth. 2007. <span>“Auxiliary Mixture Sampling with Applications to Logistic Models.”</span> <em>Computational Statistics &amp; Data Analysis</em> 51 (April): 3509–28.
</div>
<div id="ref-fruhwirth-schnatter2010" class="csl-entry" role="listitem">
———. 2010. <span>“Data <span>Augmentation</span> and <span>MCMC</span> for <span>Binary</span> and <span>Multinomial Logit Models</span>.”</span> In <em>Statistical <span>Modelling</span> and <span>Regression Structures</span>: <span>Festschrift</span> in <span>Honour</span> of <span>Ludwig Fahrmeir</span></em>, 111–32.
</div>
<div id="ref-fruhwirth-schnatter2008" class="csl-entry" role="listitem">
Frühwirth-Schnatter, Sylvia, Rudolf Frühwirth, Leonhard Held, and Håvard Rue. 2008. <span>“Improved Auxiliary Mixture Sampling for Hierarchical Models of&nbsp;Non-<span>Gaussian</span> Data.”</span> <em>Statistics and Computing</em> 19 (4): 479.
</div>
<div id="ref-gramacy2012" class="csl-entry" role="listitem">
Gramacy, Robert B., and Nicholas G. Polson. 2012. <span>“Simulation-Based <span>Regularized Logistic Regression</span>.”</span> <span>arXiv</span>. <a href="https://arxiv.org/abs/1005.3430">https://arxiv.org/abs/1005.3430</a>.
</div>
<div id="ref-held2006" class="csl-entry" role="listitem">
Held, Leonhard, and Chris C. Holmes. 2006. <span>“Bayesian Auxiliary Variable Models for Binary and Multinomial Regression.”</span> <em>Bayesian Analysis</em> 1 (1): 145–68.
</div>
<div id="ref-hyndman2021" class="csl-entry" role="listitem">
Hyndman, Rob J., and George Athanasopoulos. 2021. <em>Forecasting: <span>Principles</span> and <span>Practice</span></em>. 3rd ed. edition. <span>Melbourne, Australia</span>: <span>Otexts</span>.
</div>
<div id="ref-januschowski2022" class="csl-entry" role="listitem">
Januschowski, Tim, Yuyang Wang, Kari Torkkola, Timo Erkkilä, Hilaf Hasson, and Jan Gasthaus. 2022. <span>“Forecasting with Trees.”</span> <em>International Journal of Forecasting</em>, Special <span>Issue</span>: <span>M5</span> competition, 38 (4): 1473–81.
</div>
<div id="ref-kaggle2020" class="csl-entry" role="listitem">
kaggle. 2020. <span>“M5 <span>Forecasting</span> - <span>Accuracy</span>.”</span> https://kaggle.com/competitions/m5-forecasting-accuracy.
</div>
<div id="ref-petris2010" class="csl-entry" role="listitem">
Petris, Giovanni. 2010. <span>“An <span>R Package</span> for <span>Dynamic Linear Models</span>.”</span> <em>Journal of Statistical Software</em> 36 (October): 1–16.
</div>
<div id="ref-polson2011" class="csl-entry" role="listitem">
Polson, Nicholas, and Steven Scott. 2011. <span>“Data <span>Augmentation</span> for <span>Support Vector Machines</span>.”</span> <em>Bayesian Analysis</em> 6 (March).
</div>
<div id="ref-rubin2015" class="csl-entry" role="listitem">
Rubin, Hal S. Stern, John B. Carlin. 2015. <em>Bayesian <span>Data Analysis</span></em>. 3rd ed. <span>New York</span>: <span>Chapman and Hall/CRC</span>.
</div>
<div id="ref-scott2022" class="csl-entry" role="listitem">
Scott, Steven L. 2022. <span>“<span>BoomSpikeSlab</span>: <span>MCMC</span> for <span>Spike</span> and <span>Slab Regression</span>.”</span>
</div>
<div id="ref-scott2015" class="csl-entry" role="listitem">
Scott, Steven L., and Hal R. Varian. 2015. <span>“Bayesian <span>Variable Selection</span> for <span>Nowcasting Economic Time Series</span>.”</span> In <em>Economic <span>Analysis</span> of the <span>Digital Economy</span></em>, 119–35. <span>University of Chicago Press</span>.
</div>
<div id="ref-scott2014" class="csl-entry" role="listitem">
Scott, Steven, and Hal Varian. 2014. <span>“Predicting the <span>Present</span> with <span>Bayesian Structural Time Series</span>.”</span> <em>Int. J. Of Mathematical Modelling and Numerical Optimisation</em> 5 (January): 4–23.
</div>
<div id="ref-seanj.taylor2017" class="csl-entry" role="listitem">
Sean J. Taylor, and Ben Letham. 2017. <span>“Prophet: Forecasting at Scale - <span>Meta Research</span>.”</span> <em>Meta Research</em>. https://research.facebook.com/blog/2017/2/prophet-forecasting-at-scale/.
</div>
</div>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../qmd/tree.html" class="pagination-link  aria-label=" &lt;span="" models&lt;="" span&gt;"="">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Tree Models</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../qmd/nn.html" class="pagination-link" aria-label="<span class='chapter-number'>20</span>&nbsp; <span class='chapter-title'>Neural Networks</span>">
        <span class="nav-page-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Neural Networks</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>