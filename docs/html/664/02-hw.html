<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.37">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Homework 2. Bayes AI</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="02-hw_files/libs/clipboard/clipboard.min.js"></script>
<script src="02-hw_files/libs/quarto-html/quarto.js"></script>
<script src="02-hw_files/libs/quarto-html/popper.min.js"></script>
<script src="02-hw_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="02-hw_files/libs/quarto-html/anchor.min.js"></script>
<link href="02-hw_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="02-hw_files/libs/quarto-html/quarto-syntax-highlighting-29e2c20b02301cfff04dc8050bf30c7e.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="02-hw_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="02-hw_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="02-hw_files/libs/bootstrap/bootstrap-e19dc0c07aeef78048e587c3f1edba7a.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Homework 2. Bayes AI</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div id="exr-" class="theorem exercise">
<p><span class="theorem-title"><strong>Exercise 1 (Two Gambles)</strong></span> In an experiment, subjects were given the choice between two gambles:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th style="text-align: center;">Experiment 1</th>
<th style="text-align: center;"></th>
<th style="text-align: center;"></th>
<th style="text-align: center;"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">Gamble <span class="math inline">\({\cal G}_A\)</span></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">Gamble <span class="math inline">\({\cal G}_B\)</span></td>
<td style="text-align: center;"></td>
</tr>
<tr class="even">
<td style="text-align: center;">Win</td>
<td style="text-align: center;">Chance</td>
<td style="text-align: center;">Win</td>
<td style="text-align: center;">Chance</td>
</tr>
<tr class="odd">
<td style="text-align: center;">$2500</td>
<td style="text-align: center;">0.33</td>
<td style="text-align: center;">$2400</td>
<td style="text-align: center;">1</td>
</tr>
<tr class="even">
<td style="text-align: center;">$2400</td>
<td style="text-align: center;">0.66</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
<tr class="odd">
<td style="text-align: center;">$0</td>
<td style="text-align: center;">0.01</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
</tbody>
</table>
<p>Suppose that a person is an expected utility maximizer. Set the utility scale so that u($0) = 0 and u($2500) = 1. person is an expected utility maximizer. Set the utility scale so that u($0) = 0 and u($2500) = 1. Whether a utility maximizing person would choose Option A or Option B depends on the person’s utility for $2400. For what values of u($2400) would a rational person choose Option A? For what values would a rational person choose Option B?</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th style="text-align: center;">Experiment 2</th>
<th style="text-align: center;"></th>
<th style="text-align: center;"></th>
<th style="text-align: center;"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">Gamble <span class="math inline">\({\cal G}_C\)</span></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">Gamble <span class="math inline">\({\cal G}_D\)</span></td>
<td style="text-align: center;"></td>
</tr>
<tr class="even">
<td style="text-align: center;">Win</td>
<td style="text-align: center;">Chance</td>
<td style="text-align: center;">Win</td>
<td style="text-align: center;">Chance</td>
</tr>
<tr class="odd">
<td style="text-align: center;">$2500</td>
<td style="text-align: center;">0.33</td>
<td style="text-align: center;">$2400</td>
<td style="text-align: center;">0.34</td>
</tr>
<tr class="even">
<td style="text-align: center;">$0</td>
<td style="text-align: center;">0.67</td>
<td style="text-align: center;">$0</td>
<td style="text-align: center;">0.66</td>
</tr>
</tbody>
</table>
<p>For what values of u($2400) would a person choose Option C? For what values would a person choose Option D? Explain why no expected utility maximizer would prefer B and C.</p>
<p>This problem is a version of the famous Allais paradox, named after the prominent critic of subjective expected utility theory who first presented it. Kahneman and Tversky found that 82% of subjects preferred B over A, and 83% preferred C over D. Explain why no expected utility maximizer would prefer both B in Gamble 1 and C in Gamble 2. (A utility maximizer might prefer B in Gamble 1. A different utility maximizer might prefer C in Gamble 2. But the same utility maximizer would not prefer both B in Gamble 1 and C in Gamble</p>
<p>Discuss these results. Why do you think many people prefer B in Gamble 1 and C in Gamble 2? Do you think this is reasonable even if it does not conform to expected utility theory?</p>
<p><strong>Solution</strong>:</p>
<p>Define x = u($2400), the utility of $2400.</p>
<p>For A versus B:</p>
<ul>
<li>Expected utility of A is 0.33* (1) + 0.66<em>(x) + 0.1</em>(0)</li>
<li>Expected utility of B is x</li>
</ul>
<p>Setting them equal and solving for x tells us the value of x for which an expected utility maximizer would be indifferent between the two options <span class="math display">\[0.33* (1) + 0.66*(x) + 0.1*(0) = x\]</span> <span class="math display">\[x = 0.33/0.34.\]</span></p>
<p>For C versus D:</p>
<ul>
<li>Expected utility of C is 0.33* (1) + 0.67*(0)</li>
<li>Expected utility of D is 0.34*(x)</li>
</ul>
<p>Setting them equal and solving for x tells us the value of x for which an expected utility maximizer would be indifferent between the two options <span class="math display">\[0.33* (1) = 0.34*(x)\]</span> <span class="math display">\[x = 0.33/0.34\]</span></p>
<p>If x &lt; 33/34, then an expected utility maximizer would choose option C. If x&gt;33/34, option D an expected utility maximizer would choose option D</p>
<p>Why no utility maximizer would prefer B and C?</p>
<p>A utility maximizer would pick B if x&gt;33/34, and would pick C if x&lt;33/34. These regions do not overlap. By definition, an expected utility maximizer has a consistent utility value for a given payout regardless of the probability structure. Therefore, no utility maximizer would prefer B and C. A utility maximizer would be indifferent among all four of these gambles if x = 33/34. But no utility maximizer would strictly prefer B over A, and C over D.</p>
<p>Many people’s choices violate subjective expected utility theory in this problem. In fact, Allais carefully crafted this problem to exploit what Kahneman and Tversky called the “certainty effect.” In the choice of A vs B, many prefer a sure gain to a small chance of no gain. On the other hand, in the choice of C vs D, there is no certainty, and so people are willing to reduce their chances of winning by what feels like a small amount to give themselves a chance to win a larger amount. When given an explanation for why these choices are inconsistent with “economic rationality,” some people say they made an error and revise their choices, but others stand firmly by their choices and reject expected utility theory.</p>
<p>It is also interesting to look at how people respond to a third choice:</p>
<p>Experiment 3:</p>
<p>This is a two-stage problem. In the first stage there is a 66% chance you will win nothing and quit. There is a 34% chance you will go on to the second stage. In the second stage you may choose between the following two options.</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th style="text-align: left;">Gamble</th>
<th style="text-align: left;">Payout</th>
<th style="text-align: left;">Probability</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">E</td>
<td style="text-align: left;">$2500</td>
<td style="text-align: left;">33/34</td>
</tr>
<tr class="even">
<td style="text-align: left;">E</td>
<td style="text-align: left;">$0</td>
<td style="text-align: left;">1/34</td>
</tr>
<tr class="odd">
<td style="text-align: left;">F</td>
<td style="text-align: left;">$2400</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">F</td>
<td style="text-align: left;">$0</td>
<td style="text-align: left;">1/34</td>
</tr>
</tbody>
</table>
<p>Experiment 3 is mathematically equivalent to Experiment 2. That is, the probability distributions of the outcomes for E and C are the same, and the probability distributions of the outcomes for F and D are the same. In experiments, the most common pattern of choices on these problems is to prefer B, C, and F. There is an enormous literature on the Allais paradox and related ways in which people systematically violate the principles of expected utility theory. For more information see <a href="http://en.wikipedia.org/wiki/Allais_paradox">Wikipedia on Allais paradox</a>.</p>
</div>
<div id="exr-" class="theorem exercise">
<p><span class="theorem-title"><strong>Exercise 2 (Tarone Study)</strong></span> <span class="citation" data-cites="tarone1982use">Tarone (<a href="#ref-tarone1982use" role="doc-biblioref">1982</a>)</span> reports data from 71 studies on tumor incidence in rats</p>
<ol type="a">
<li>In one of the studies, 2 out of 13 rats had tumors. Assume there are 20 possible tumor probabilities: <span class="math inline">\(0.025, 0.075,\ldots, 0.975\)</span>. Assume that the tumor probability is uniformly distributed. Find the posterior distribution for the tumor probability given the data for this study.</li>
<li>Repeat Part a for a second study in which 1 in 18 rats had a tumor.</li>
<li>Parts a and b assumed that each study had a different tumor probability, and that these tumor probabilities were uniformly distributed a priori. Now, assume the tumor probabilities are the same for the two studies, and that this probability has a uniform prior distribution. Find the posterior distribution for the common tumor probability given the combined results from the two studies.</li>
<li>Compare the three distributions for Parts a, b, and c.&nbsp;Comment on your results.</li>
</ol>
<p><strong>Solution</strong>:</p>
<p>We assume that tumors occur independently, with a probability of <span class="math inline">\(\Theta\)</span> of a tumor in each rat in the study. Our data <span class="math inline">\(X\)</span> consist of observations on <span class="math inline">\(N\)</span> rats, in which we record which rats have tumors. We can use either of two methods to represent the likelihood of what we have observed:</p>
<p>Method 1: We list, for each observation, whether or not the rat has a tumor. We multiply together the probability of getting the observation we obtained: <span class="math inline">\(\Theta\)</span> if the rat has a tumor, and 1-<span class="math inline">\(\Theta\)</span> if the rat does not have a tumor. If x out of n rats have tumors, the probability of observing this sequence of observations is <span class="math inline">\(\Theta^k(1-\Theta)^{n-k}\)</span>. Using Method 1, the posterior distribution for <span class="math inline">\(\Theta\)</span> is given by: <span class="math display">\[
g (\theta | x ) = \dfrac{f ( x | \theta ) g (\theta )}{\sum_{i=1}^{20} f ( x | \theta_i ) g (\theta_i )} = \dfrac{\theta^x (1 − \theta )^{n- x}}{\sum_{i=1}^{20} \theta_i^x (1 − \theta_i )^{n − x}}
\]</span></p>
<p>Method 2: We count how many of the rats have tumors. We remember from our previous statistics class that if the tumors occur independently with probability <span class="math inline">\(\Theta\)</span>, the number of rats with tumors out of a total of <span class="math inline">\(n\)</span> rats will have a Binomial distribution with parameters <span class="math inline">\(n\)</span> and <span class="math inline">\(\Theta\)</span>. The probability of getting <span class="math inline">\(k\)</span> tumors is <span class="math display">\[
C_n^k \theta^k (1 − \theta )^{n − k},\quad k = 0, 1, 2, ..., n,\quad \mathrm{where}\quad C_n^k = \dfrac{n!}{k!(n-k)!}
\]</span> Then, the posterior distribution for <span class="math inline">\(\Theta\)</span> is given by: <span class="math display">\[
g (\theta | x ) = \dfrac{f ( x | \theta ) g (\theta )}{\sum_{i=1}^{20} f ( x | \theta_i ) g (\theta_i )} = \dfrac{C_n^k \theta^x (1 − \theta )^{n − x}}{\sum_{i=1}^{20} C_n^k \theta_i^x (1 − \theta_i )^{n − x}}
\]</span></p>
<p>In Method 1, we are representing the likelihood of getting this exact sequence of observations. In Method 2, we are representing the likelihood of getting this number of tumors.</p>
<p>It is clear that the two methods give the same posterior distribution, because the constant <span class="math inline">\(C_n^k\)</span> cancels out of the numerator and denominator of Bayes rule. That is, the number of tumors is a sufficient statistic for <span class="math inline">\(\Theta\)</span>, and the order in which the tumors occur is irrelevant.</p>
<p>Part a. The posterior distribution for <span class="math inline">\(\Theta_1\)</span>, the tumor probability in the first study, is: <span class="math display">\[
g (\theta | x =2) = \dfrac{\theta^2 (1 − \theta )^{11}}{\sum_{i=1}^{20} \theta_i^2 (1 − \theta_i )^{11}}
\]</span></p>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>theta <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>, <span class="fl">0.05</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>prior <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">20</span>, <span class="dv">20</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>tarone <span class="ot">=</span> <span class="cf">function</span>(n,k) {</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    likelihood <span class="ot">&lt;-</span> theta<span class="sc">^</span>k <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> theta)<span class="sc">^</span>(n<span class="sc">-</span>k)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    posterior <span class="ot">&lt;-</span> likelihood <span class="sc">*</span> prior <span class="sc">/</span> <span class="fu">sum</span>(likelihood <span class="sc">*</span> prior)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="fu">data.frame</span>(theta, likelihood, posterior)))</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">barplot</span>(posterior, <span class="at">names.arg =</span> theta, <span class="at">xlab =</span> <span class="fu">expression</span>(theta), <span class="at">ylab =</span> <span class="st">"Pr(theta | X)"</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(posterior)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>posta <span class="ot">=</span> <span class="fu">tarone</span>(<span class="dv">13</span>,<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="cell-output cell-output-stdout quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<pre><code>

| theta| likelihood| posterior|
|-----:|----------:|---------:|
|  0.03|          0|      0.03|
|  0.08|          0|      0.13|
|  0.12|          0|      0.20|
|  0.18|          0|      0.20|
|  0.22|          0|      0.17|
|  0.28|          0|      0.12|
|  0.33|          0|      0.08|
|  0.38|          0|      0.04|
|  0.43|          0|      0.02|
|  0.48|          0|      0.01|
|  0.52|          0|      0.00|
|  0.58|          0|      0.00|
|  0.63|          0|      0.00|
|  0.68|          0|      0.00|
|  0.73|          0|      0.00|
|  0.78|          0|      0.00|
|  0.83|          0|      0.00|
|  0.88|          0|      0.00|
|  0.92|          0|      0.00|
|  0.98|          0|      0.00|</code></pre>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<p><img src="02-hw_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</div>
<p>Part b. The posterior distribution for <span class="math inline">\(\Theta_2\)</span>, the tumor probability in the second study, is: <span class="math display">\[
g (\theta | x =2) = \dfrac{\theta (1 − \theta )^{17}}{\sum_{i=1}^{20} \theta_i(1 − \theta_i )^{17}}
\]</span></p>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>postb  <span class="ot">=</span> <span class="fu">tarone</span>(<span class="dv">18</span>,<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="cell-output cell-output-stdout quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<pre><code>

| theta| likelihood| posterior|
|-----:|----------:|---------:|
|  0.03|       0.02|      0.27|
|  0.08|       0.02|      0.33|
|  0.12|       0.01|      0.21|
|  0.18|       0.01|      0.11|
|  0.22|       0.00|      0.05|
|  0.28|       0.00|      0.02|
|  0.33|       0.00|      0.01|
|  0.38|       0.00|      0.00|
|  0.43|       0.00|      0.00|
|  0.48|       0.00|      0.00|
|  0.52|       0.00|      0.00|
|  0.58|       0.00|      0.00|
|  0.63|       0.00|      0.00|
|  0.68|       0.00|      0.00|
|  0.73|       0.00|      0.00|
|  0.78|       0.00|      0.00|
|  0.83|       0.00|      0.00|
|  0.88|       0.00|      0.00|
|  0.92|       0.00|      0.00|
|  0.98|       0.00|      0.00|</code></pre>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<p><img src="02-hw_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</div>
<p>Part c.&nbsp;If the tumor probabilities are the same in the two studies, it is appropriate to treat them as a single study in which 3 rats out of 31 have a tumor. The posterior distribution for <span class="math inline">\(\Theta\)</span>, the common tumor probability, is: <span class="math display">\[
g (\theta | x =2) = \dfrac{\theta^3 (1 − \theta )^{28}}{\sum_{i=1}^{20} \theta_i^3(1 − \theta_i )^{28}}
\]</span></p>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>postc <span class="ot">=</span> <span class="fu">tarone</span>(<span class="dv">31</span>,<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="cell-output cell-output-stdout quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<pre><code>

| theta| likelihood| posterior|
|-----:|----------:|---------:|
|  0.03|          0|      0.06|
|  0.08|          0|      0.34|
|  0.12|          0|      0.34|
|  0.18|          0|      0.18|
|  0.22|          0|      0.07|
|  0.28|          0|      0.02|
|  0.33|          0|      0.00|
|  0.38|          0|      0.00|
|  0.43|          0|      0.00|
|  0.48|          0|      0.00|
|  0.52|          0|      0.00|
|  0.58|          0|      0.00|
|  0.63|          0|      0.00|
|  0.68|          0|      0.00|
|  0.73|          0|      0.00|
|  0.78|          0|      0.00|
|  0.83|          0|      0.00|
|  0.88|          0|      0.00|
|  0.92|          0|      0.00|
|  0.98|          0|      0.00|</code></pre>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<p><img src="02-hw_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</div>
<p>It is useful to verify that we get the same posterior distribution by using Method 2 to calculate the likelihood of the data. It is also useful to verify that we would get the same results in Part c if we used the posterior distribution from Part a as the prior distribution for Part c, and the likelihood from Part b as the likelihood for part c.&nbsp;That is, we would get the same result from a two-step process, in which we started with a uniform prior distribution, incorporated the results from the first study to obtain a posterior distribution, and then incorporated the results from the second study to get a new posterior distribution.</p>
<p>Part d. We can compare the distributions more easily if we plot the prior distribution, the posterior distributions for the parameters of the two individual studies, and the combined posterior distribution together (see below). We see that the posterior distribution from the first study puts more probability on higher values of <span class="math inline">\(\Theta\)</span> than the posterior distribution for the second study. This is not surprising, because a higher proportion of rats in the first study had tumors. There is a great deal of overlap in the two distributions, which suggests that the two probabilities may be the same. Thus, it is reasonable to consider combining the two samples. If there had been very little overlap in the posterior distributions from Parts a and b, it would not have been reasonable to combine the studies. Later in the semester, we will look more carefully at the problem of when to combine probabilities and when to estimate them separately. When the studies are combined, the posterior distribution is narrower than the posterior distribution for either of the two individual studies, with less probability on very low and very high values of <span class="math inline">\(\Theta\)</span>. Note that the combined distribution is consistent with both of the individual distributions, in the sense that it places high probability on values that also have high probability in the other two distributions. The combined distribution is more concentrated around values close to the combined sample proportion of about 1 in 10.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>allDist<span class="ot">=</span><span class="fu">rbind</span>(prior,posta,postb,postc) </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">barplot</span>(allDist,<span class="at">main=</span><span class="st">"Prior and Posterior Distributions for TumorProbability"</span>,<span class="at">xlab=</span><span class="st">"Theta"</span>,<span class="at">ylab=</span><span class="st">"Probability"</span>, <span class="at">col=</span><span class="fu">c</span>(<span class="st">"mediumpurple"</span>,<span class="st">"lightblue"</span>,<span class="st">"pink"</span>,<span class="st">"lightgreen"</span>), <span class="at">border=</span><span class="fu">c</span>(<span class="st">"darkviolet"</span>,<span class="st">"darkblue"</span>, <span class="st">"red"</span>,<span class="st">"darkgreen"</span>),<span class="at">names.arg=</span>theta, <span class="at">legend=</span><span class="fu">c</span>(<span class="st">"Prior"</span>,<span class="st">"Study 1"</span>, <span class="st">"Study 2"</span>, <span class="st">"Both Studies"</span>), <span class="at">beside=</span><span class="cn">TRUE</span>, <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">0.4</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02-hw_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="exr-" class="theorem exercise">
<p><span class="theorem-title"><strong>Exercise 3 (Poisson MLE vs Baye)</strong></span> You are developing tools for monitoring number of advertisemnt clicks on a website. You have observed the following data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>y <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">7</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">6</span>,<span class="dv">5</span>,<span class="dv">5</span>,<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">4</span>,<span class="dv">7</span>,<span class="dv">5</span>,<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>which represents the number of clicks every minute over the last 10 minutes. You assume that the number of clicks per minute follows a Poisson distribution with parameter <span class="math inline">\(\lambda\)</span>.</p>
<ol type="a">
<li>Plot likelihood function for <span class="math inline">\(\lambda\)</span>.</li>
<li>Estimate <span class="math inline">\(\lambda\)</span> using Maximum Likelihood Estimation (MLE). MLE is the value of <span class="math inline">\(\lambda\)</span> that maximizes the likelihood function or log-likelihood function. Maximizing likelihood is equivalent to maximizing the log-likelihood function (log is a monotonically increasing function).</li>
<li>Using <code>barplot</code>, plot the predicted vs observed probabilities of for number of clicks from 1 to 7. Is the model a good fit?</li>
<li>Assume that you know, that historically, the average number of clicks per minute is 4 and variance is also 4. Those numbers were valculated over a long period of time. You can use this information as a prior. Assume that the prior distribution is <span class="math inline">\(Gamma(\alpha,\beta)\)</span>. What would be appropriate values for <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span> that would represent this prior information?</li>
<li>Find the posterior distribution for <span class="math inline">\(\lambda\)</span> and calculate the Bayesian estimate for <span class="math inline">\(\lambda\)</span> as the expectation over the posterior.</li>
<li>After collecting data for a few days, you realized that about 20% of the observations are zero. How this information would change your prior distribution? This is an open-ended question.</li>
</ol>
<p><em>Hint</em>: For part c, you can use the following code to calculate the predicted probabilities for the number of clicks from 0 to 5.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>tb <span class="ot">=</span> <span class="fu">table</span>(y)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>observed <span class="ot">=</span> tb<span class="sc">/</span><span class="fu">length</span>(y)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>predicted <span class="ot">=</span> <span class="fu">dpois</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>,lambda_mle)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Solution</strong>: a)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>lambda <span class="ot">=</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">10</span>, <span class="fl">0.1</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>likelihood <span class="ot">=</span> <span class="fu">sapply</span>(lambda, <span class="cf">function</span>(l) <span class="fu">prod</span>(<span class="fu">dpois</span>(y, l)))</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(lambda, likelihood, <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">xlab =</span> <span class="fu">expression</span>(lambda), <span class="at">ylab =</span> <span class="st">"Likelihood"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02-hw_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<ol start="2" type="a">
<li></li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>lambda_mle <span class="ot">=</span> <span class="fu">optim</span>(<span class="at">par =</span> <span class="dv">1</span>, <span class="at">fn =</span> <span class="cf">function</span>(l) <span class="sc">-</span><span class="fu">sum</span>(<span class="fu">dpois</span>(y, l, <span class="at">log =</span> <span class="cn">TRUE</span>)))<span class="sc">$</span>par</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in optim(par = 1, fn = function(l) -sum(dpois(y, l, log = TRUE))): one-dimensional optimization by Nelder-Mead is unreliable:
use "Brent" or optimize() directly</code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>lambda_mle</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4</code></pre>
</div>
</div>
<p>Alternatively, the likelihood function is <span class="math display">\[
L(\lambda) = \prod_{i=1}^{n} \frac{\lambda^{y_i}e^{-\lambda}}{y_i!}
\]</span> and the log-likelihood function is <span class="math display">\[
\log L(\lambda) = \sum_{i=1}^{n} y_i \log(\lambda) - n\lambda
\]</span> The MLE is the value of <span class="math inline">\(\lambda\)</span> that maximizes the log-likelihood function. We can find the MLE by taking the derivative of the log-likelihood function with respect to <span class="math inline">\(\lambda\)</span> and setting it equal to zero. This gives <span class="math display">\[
\frac{d}{d\lambda} \log L(\lambda) = \frac{1}{\lambda} \sum_{i=1}^{n} y_i - n = 0
\]</span> Solving for <span class="math inline">\(\lambda\)</span> gives <span class="math display">\[
\lambda = \frac{1}{n} \sum_{i=1}^{n} y_i.
\]</span> A simple average of the data gives the MLE for <span class="math inline">\(\lambda\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4</code></pre>
</div>
</div>
<ol start="3" type="a">
<li></li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">=</span> <span class="fu">table</span>(y)<span class="sc">/</span><span class="fu">length</span>(y)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>poisson <span class="ot">=</span> <span class="fu">dpois</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>,lambda_mle)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>d <span class="ot">=</span> <span class="fu">cbind</span>(pred, poisson)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="fu">barplot</span>(<span class="fu">t</span>(d),<span class="at">names.arg=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>, <span class="at">xlab =</span> <span class="st">"Clicks"</span>, <span class="at">ylab =</span> <span class="st">"Frequency"</span>, <span class="at">beside =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02-hw_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<ol start="4" type="a">
<li>We know that <span class="math inline">\(E(X) = \alpha/\beta = 4\)</span> and <span class="math inline">\(Var(X) = \alpha/\beta^2 = 4\)</span>. For example, <span class="math inline">\(\alpha = 4\)</span> and <span class="math inline">\(\beta = 1\)</span> would match the historical data.</li>
<li></li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>alpha <span class="ot">=</span> <span class="dv">4</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>beta <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>alphas <span class="ot">=</span> alpha <span class="sc">+</span> <span class="fu">sum</span>(y)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>betas <span class="ot">=</span> beta <span class="sc">+</span> <span class="fu">length</span>(y)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>lambda_bayes <span class="ot">=</span> alphas<span class="sc">/</span>betas</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="fu">data.frame</span>(<span class="at">alpha =</span> alphas, <span class="at">beta =</span> betas, <span class="at">lambda_bayes =</span> lambda_bayes))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">alpha</th>
<th style="text-align: right;">beta</th>
<th style="text-align: right;">lambda_bayes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">83</td>
<td style="text-align: right;">21</td>
<td style="text-align: right;">4</td>
</tr>
</tbody>
</table>
</div>
</div>
<ol start="6" type="a">
<li>We can use a mixture prior with one component concentrated around zero and another component concentrated around the mean that is calculated by removing zeroes from the data. The component weights are 0.2 and 0.8 respectively.</li>
</ol>
</div>
<div id="exr-" class="theorem exercise">
<p><span class="theorem-title"><strong>Exercise 4 (Exponential Distribution)</strong></span> Let <span class="math inline">\(x_1, x_2,\ldots, x_N\)</span> be an independent sample from the exponential distribution with density <span class="math inline">\(p (x | \lambda) = \lambda\exp (-\lambda x)\)</span>, <span class="math inline">\(x \ge 0\)</span>, <span class="math inline">\(\lambda&gt; 0\)</span>. Find the maximum likelihood estimate <span class="math inline">\(\lambda_{\text{ML}}\)</span>. Choose the conjugate prior distribution <span class="math inline">\(p (\lambda)\)</span>, and find the posterior distribution <span class="math inline">\(p (\lambda | x_1,\ldots, x_N)\)</span> and calculate the Bayesian estimate for <span class="math inline">\(\lambda\)</span> as the expectation over the posterior.</p>
</div>


<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-tarone1982use" class="csl-entry" role="listitem">
Tarone, Robert E. 1982. <span>“The Use of Historical Control Information in Testing for a Trend in Proportions.”</span> <em>Biometrics</em>, 215–20.
</div>
</div></section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>