<!DOCTYPE html>
<html lang="en"><head>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-html/tabby.min.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/light-border.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-29e2c20b02301cfff04dc8050bf30c7e.css" rel="stylesheet" id="quarto-text-highlighting-styles"><meta charset="utf-8">
  <meta name="generator" content="quarto-1.6.37">

  <meta name="author" content="Vadim Sokolov   George Mason University   Spring 2025">
  <title>Bayes AI</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="site_libs/revealjs/dist/reset.css">
  <link rel="stylesheet" href="site_libs/revealjs/dist/reveal.css">
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
      vertical-align: middle;
    }
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      { color: #003b4f; background-color: #f1f3f5; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span { color: #003b4f; } /* Normal */
    code span.al { color: #ad0000; } /* Alert */
    code span.an { color: #5e5e5e; } /* Annotation */
    code span.at { color: #657422; } /* Attribute */
    code span.bn { color: #ad0000; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #003b4f; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #20794d; } /* Char */
    code span.cn { color: #8f5902; } /* Constant */
    code span.co { color: #5e5e5e; } /* Comment */
    code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
    code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
    code span.dt { color: #ad0000; } /* DataType */
    code span.dv { color: #ad0000; } /* DecVal */
    code span.er { color: #ad0000; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #ad0000; } /* Float */
    code span.fu { color: #4758ab; } /* Function */
    code span.im { color: #00769e; } /* Import */
    code span.in { color: #5e5e5e; } /* Information */
    code span.kw { color: #003b4f; font-weight: bold; } /* Keyword */
    code span.op { color: #5e5e5e; } /* Operator */
    code span.ot { color: #003b4f; } /* Other */
    code span.pp { color: #ad0000; } /* Preprocessor */
    code span.sc { color: #5e5e5e; } /* SpecialChar */
    code span.ss { color: #20794d; } /* SpecialString */
    code span.st { color: #20794d; } /* String */
    code span.va { color: #111111; } /* Variable */
    code span.vs { color: #20794d; } /* VerbatimString */
    code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="site_libs/revealjs/dist/theme/quarto-bbe7401fe57d4b791b917637bb662036.css">
  <link rel="stylesheet" href="style.css">
  <link href="site_libs/revealjs/plugin/quarto-line-highlight/line-highlight.css" rel="stylesheet">
  <link href="site_libs/revealjs/plugin/reveal-menu/menu.css" rel="stylesheet">
  <link href="site_libs/revealjs/plugin/reveal-menu/quarto-menu.css" rel="stylesheet">
  <link href="site_libs/revealjs/plugin/reveal-chalkboard/font-awesome/css/all.css" rel="stylesheet">
  <link href="site_libs/revealjs/plugin/reveal-chalkboard/style.css" rel="stylesheet">
  <link href="site_libs/revealjs/plugin/quarto-support/footer.css" rel="stylesheet">
  <style type="text/css">
    .reveal div.sourceCode {
      margin: 0;
      overflow: auto;
    }
    .reveal div.hanging-indent {
      margin-left: 1em;
      text-indent: -1em;
    }
    .reveal .slide:not(.center) {
      height: 100%;
      overflow-y: auto;
    }
    .reveal .slide.scrollable {
      overflow-y: auto;
    }
    .reveal .footnotes {
      height: 100%;
      overflow-y: auto;
    }
    .reveal .slide .absolute {
      position: absolute;
      display: block;
    }
    .reveal .footnotes ol {
      counter-reset: ol;
      list-style-type: none; 
      margin-left: 0;
    }
    .reveal .footnotes ol li:before {
      counter-increment: ol;
      content: counter(ol) ". "; 
    }
    .reveal .footnotes ol li > p:first-child {
      display: inline-block;
    }
    .reveal .slide ul,
    .reveal .slide ol {
      margin-bottom: 0.5em;
    }
    .reveal .slide ul li,
    .reveal .slide ol li {
      margin-top: 0.4em;
      margin-bottom: 0.2em;
    }
    .reveal .slide ul[role="tablist"] li {
      margin-bottom: 0;
    }
    .reveal .slide ul li > *:first-child,
    .reveal .slide ol li > *:first-child {
      margin-block-start: 0;
    }
    .reveal .slide ul li > *:last-child,
    .reveal .slide ol li > *:last-child {
      margin-block-end: 0;
    }
    .reveal .slide .columns:nth-child(3) {
      margin-block-start: 0.8em;
    }
    .reveal blockquote {
      box-shadow: none;
    }
    .reveal .tippy-content>* {
      margin-top: 0.2em;
      margin-bottom: 0.7em;
    }
    .reveal .tippy-content>*:last-child {
      margin-bottom: 0.2em;
    }
    .reveal .slide > img.stretch.quarto-figure-center,
    .reveal .slide > img.r-stretch.quarto-figure-center {
      display: block;
      margin-left: auto;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-left,
    .reveal .slide > img.r-stretch.quarto-figure-left  {
      display: block;
      margin-left: 0;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-right,
    .reveal .slide > img.r-stretch.quarto-figure-right  {
      display: block;
      margin-left: auto;
      margin-right: 0; 
    }
  </style>
  <script src="site_libs/quarto-diagram/mermaid.min.js"></script>
  <script src="site_libs/quarto-diagram/mermaid-init.js"></script>
  <link href="site_libs/quarto-diagram/mermaid.css" rel="stylesheet">
</head>
<body class="quarto-light">
  <div class="reveal">
    <div class="slides">

<section id="title-slide" class="center">
  <h1 class="title" style="font-size:40px;">Bayes AI</h1>
  <p class="subtitle" style="color:blue;font-size:50px;">Unit 5: Stochastic Processes</p>
<img style="height: 350px;" src="fig/page/06-sp.jpg">
  <p class="author">Vadim Sokolov <br> George Mason University <br> Spring 2025</p>

<p style="font-size:10px;"> 
<a href="https://vsokolov.org/courses/664.html">Course Page</a>, <a href="https://vsokolov.org/html/664/slides/">Slides</a>
</p>


</section>
<section id="definition" class="slide level2">
<h2>Definition</h2>
<ul>
<li>An instance (realization) of a process is a function <span class="math inline">\(Y:~ U \rightarrow S\)</span></li>
<li>From domain of index set <span class="math inline">\(U\)</span></li>
<li>To process values <span class="math inline">\(S\)</span>, called state-space.</li>
</ul>
<p>The process then is the <em>distribution over the space of functions</em> from <span class="math inline">\(U\)</span> to <span class="math inline">\(S\)</span>.</p>
</section>
<section>
<section id="examples" class="title-slide slide level1 center scrollable">
<h1>Examples</h1>
<ol type="1">
<li>Random Walk, e.g.&nbsp;stock prices</li>
<li>Markov Chains: chess</li>
<li>Poisson Process</li>
<li>Queuing Theory: number of customers in a queue, varying over time as customers arrive and are served.</li>
<li>Gaussian Processes: engineering surrogates</li>
</ol>
</section>
<section id="brownian-motion" class="slide level2">
<h2>Brownian Motion</h2>
<ul>
<li>Brownian Motion, named after botanist Robert Brown</li>
<li>Is a fundamental concept in the theory of stochastic processes.</li>
<li>It describes the random motion of particles suspended in a fluid (liquid or gas), as they are bombarded by the fast-moving molecules in the fluid.</li>
</ul>
<p>A one-dimensional Brownian Motion (also known as Wiener process) is a continuous time stochastic process <span class="math inline">\(B(t)_{t\ge 0}\)</span> with the following properties</p>
<ul>
<li><span class="math inline">\(B(0) = 0\)</span> almost surely</li>
<li><span class="math inline">\(B(t)\)</span> has stationary independent increments: <span class="math inline">\(B(t) - B(s) \sim N(0, t-s)\)</span> for <span class="math inline">\(0 \le s &lt; t\)</span></li>
<li><span class="math inline">\(B(t)\)</span> is continuous function of <span class="math inline">\(t\)</span></li>
<li>For each time <span class="math inline">\(t &gt; 0\)</span>, the random variable <span class="math inline">\(B(t)\)</span> is normally distributed with mean 0 and variance <span class="math inline">\(t\)</span>, i.e., <span class="math inline">\(B(t) \sim N(0, t)\)</span>.</li>
</ul>
</section>
<section id="formal-definition" class="slide level2">
<h2>Formal Definition</h2>
<p>Formally brownian motion is a stochastic process <span class="math inline">\(B(t)\)</span> is a family of real random variables indexed by the set of nonnegative real numbers <span class="math inline">\(t\)</span>.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a></a><span class="co"># Brownian Motion</span></span>
<span id="cb1-2"><a></a><span class="fu">set.seed</span>(<span class="dv">92</span>)</span>
<span id="cb1-3"><a></a>t <span class="ot">=</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.001</span>)</span>
<span id="cb1-4"><a></a><span class="fu">plot</span>(t, <span class="fu">cumsum</span>(<span class="fu">rnorm</span>(<span class="dv">1001</span>, <span class="dv">0</span>, <span class="fu">sqrt</span>(<span class="fl">0.001</span>))), <span class="at">type=</span><span class="st">"l"</span>, <span class="at">xlab=</span><span class="st">"t"</span>, <span class="at">ylab=</span><span class="st">"B(t)"</span>, <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="fl">1.2</span>, <span class="dv">2</span>))</span>
<span id="cb1-5"><a></a><span class="fu">lines</span>(t, <span class="fu">cumsum</span>(<span class="fu">rnorm</span>(<span class="dv">1001</span>, <span class="dv">0</span>, <span class="fu">sqrt</span>(<span class="fl">0.001</span>))), <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">col=</span><span class="dv">2</span>)</span>
<span id="cb1-6"><a></a><span class="fu">lines</span>(t, <span class="fu">cumsum</span>(<span class="fu">rnorm</span>(<span class="dv">1001</span>, <span class="dv">0</span>, <span class="fu">sqrt</span>(<span class="fl">0.001</span>))),<span class="at">lwd=</span><span class="dv">2</span>, <span class="at">col=</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>

</div>
<img data-src="05-sp_files/figure-revealjs/fig-brownian-1.png" width="960" class="r-stretch quarto-figure-center" id="fig-brownian"><p class="caption">
Figure&nbsp;1: Brownian Motion
</p><p>Thus, for any times <span class="math inline">\(0 \leq t_1 &lt; t_2 &lt; ... &lt; t_n\)</span>, the random variables <span class="math inline">\(B(t_2) - B(t_1)\)</span>, <span class="math inline">\(B(t_3) - B(t_2)\)</span>, …, <span class="math inline">\(B(t_n) - B(t_{n-1})\)</span> are independent and the function <span class="math inline">\(t \mapsto B(t)\)</span> is continuous almost surely.</p>
</section>
<section id="mertons-jump-diffusion-model" class="slide level2 smaller">
<h2>Merton’s Jump Diffusion Model</h2>
<ul>
<li>Introduced jumps to the model.</li>
<li>The additive jump term addresses the issues, asymmetry, and heavy tails in the distribution.</li>
<li>Merton’s Jump Stochastic volatility model has a discrete-time version for log-returns, <span class="math inline">\(y_t\)</span>, with jump times, <span class="math inline">\(J_t\)</span>, jump sizes, <span class="math inline">\(Z_t\)</span>, and spot stochastic volatility, <span class="math inline">\(V_t\)</span>, given by the dynamics <span class="math display">\[\begin{align*}
  y_{t} &amp; \equiv \log \left( S_{t}/S_{t-1}\right) =\mu + V_t \varepsilon_{t}+J_{t}Z_{t} \\V_{t+1} &amp; = \alpha_v + \beta_v V_t + \sigma_v \sqrt{V_t} \varepsilon_{t}^v
\end{align*}\]</span> where <span class="math inline">\(\mathbb{P} \left ( J_t =1 \right ) = \lambda\)</span>, <span class="math inline">\(S_t\)</span> denote a stock or asset price and log-returns <span class="math inline">\(y^t\)</span> is the log-return. The errors <span class="math inline">\((\varepsilon_{t},\varepsilon_{t}^v)\)</span> are possibly correlated bivariate normals.</li>
</ul>
<p>The investor must obtain optimal filters for <span class="math inline">\((V_t,J_t,Z_t)\)</span>, and learn the posterior densities of the parameters <span class="math inline">\((\mu, \alpha_v, \beta_v, \sigma_v^2 , \lambda )\)</span>. These estimates will be conditional on the information available at each time.</p>
</section>
<section id="gaussian-processes" class="slide level2">
<h2>Gaussian Processes</h2>
<ul>
<li>A Gaussian Process (GP) is a collection of random variables, any finite number of which have a joint Gaussian distribution.</li>
<li>Used for modeling and predicting, e.g.&nbsp;regression and classification tasks in machine learning.</li>
<li><span class="math inline">\(n\)</span> points from Gaussian Process is completely specified by its <span class="math inline">\(n\)</span>-dimensional mean <span class="math inline">\(\mu\)</span> and covariance matrix <span class="math inline">\(\Sigma\)</span>.</li>
<li>Index of the GP is a real number <span class="math inline">\(x\)</span> and values are also real numbers.</li>
</ul>
</section>
<section id="need-to-define-mean-and-covariance-functions" class="slide level2">
<h2>Need to define mean and covariance functions</h2>
<ul>
<li>Typically: <span class="math inline">\(U = \mathbb{R^d}\)</span>, <span class="math inline">\(S = \mathbb{R}\)</span></li>
<li>Mean <span class="math inline">\(m(x):~ U \rightarrow S\)</span> and covariance is defined by function <span class="math inline">\(k(x, x'): :~ U\times U \rightarrow S\)</span>, <span class="math inline">\(x,x' \in U\)</span></li>
<li>The mean function defines the average value of the function at point <span class="math inline">\(x\)</span></li>
<li>Covariance function, also known as the kernel, defines the extent to which the values of the function at two points <span class="math inline">\(x\)</span> and <span class="math inline">\(x'\)</span> are correlated.</li>
<li>Typical notation is <span class="math display">\[
f(x) \sim \mathcal{GP}(m(x), k(x, x')).
\]</span></li>
</ul>
<p><span class="math inline">\(k(x, x') = \mathbb{E}[(f(x) - m(x))(f(x') - m(x'))]\)</span> describes the amount of dependence between the values of the function at two different points in the input space.</p>
</section>
<section id="need-to-define-mean-and-covariance-functions-1" class="slide level2">
<h2>Need to define mean and covariance functions</h2>
<ul>
<li>Typically the mean function is less important than the covariance function.</li>
<li>Most of the time data scientists will use a zero mean function, <span class="math inline">\(m(x)=0\)</span>, and focus on the covariance function.</li>
<li>The kernel function is often chosen to be a function of the distance between the two points <span class="math inline">\(d = \|x-x'\|_2\)</span>.</li>
<li>Typically kernel function peaks at <span class="math inline">\(d=0\)</span> and decays as <span class="math inline">\(d\)</span> increases.</li>
</ul>
</section>
<section id="squared-exponential" class="slide level2">
<h2>Squared exponential</h2>
<ul>
<li>The most commonly used kernel function is the squared exponential kernel <span class="math display">\[
k(x, x') = \sigma^2 \exp\left(-\frac{\|x-x'\|_2^2}{2l^2}\right)
\]</span></li>
<li><span class="math inline">\(\sigma^2\)</span> is the variance, controls the vertical variation (amplitude)</li>
<li><span class="math inline">\(l\)</span> is the length scale parameter, controls horizontal variation (number of “bumps” or smoothness)</li>
</ul>
<p><span class="math inline">\(k(x,x) = \sigma^2\)</span> and <span class="math inline">\(k(x,x') \rightarrow 0\)</span> as <span class="math inline">\(\|x-x'\|_2 \rightarrow \infty\)</span>.</p>
</section>
<section id="gaussian-process-demo" class="slide level2">
<h2>Gaussian Process Demo</h2>
<p>Generating a sequence 100 inputs (process indexes)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a></a>x <span class="ot">=</span> <span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">10</span>, <span class="at">length.out =</span> <span class="dv">100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and then define the mean function and the covariance function</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a></a>mean <span class="ot">=</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">length</span>(x))</span>
<span id="cb3-2"><a></a>sqexpcov <span class="ot">=</span> <span class="cf">function</span>(x, x1, <span class="at">l=</span><span class="dv">1</span>, <span class="at">sigma=</span><span class="dv">1</span>) {</span>
<span id="cb3-3"><a></a>  <span class="fu">exp</span>(<span class="sc">-</span><span class="fl">0.5</span> <span class="sc">*</span> (x <span class="sc">-</span> x1)<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> l<span class="sc">^</span><span class="dv">2</span>) <span class="sc">*</span> sigma<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb3-4"><a></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The covariance matrix is then defined as</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a></a>cov_mat <span class="ot">=</span> <span class="fu">outer</span>(x, x, sqexpcov)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="gaussian-process-demo-1" class="slide level2">
<h2>Gaussian Process Demo</h2>
<p>Generate a sample from the GP using the <code>mvrnorm</code> function from the <code>MASS</code> package and plot a sample</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a></a><span class="fu">library</span>(MASS)</span>
<span id="cb5-2"><a></a><span class="fu">set.seed</span>(<span class="dv">17</span>)</span>
<span id="cb5-3"><a></a>Y <span class="ot">=</span> <span class="fu">mvrnorm</span>(<span class="dv">1</span>, mean, cov_mat)</span>
<span id="cb5-4"><a></a><span class="fu">plot</span>(x, Y, <span class="at">type=</span><span class="st">"l"</span>, <span class="at">xlab=</span><span class="st">"x"</span>, <span class="at">ylab=</span><span class="st">"y"</span>, <span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="fl">1.5</span>,<span class="dv">2</span>), <span class="at">lwd=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>

</div>
<img data-src="05-sp_files/figure-revealjs/fig-gp-sample-1.png" width="960" class="r-stretch quarto-figure-center" id="fig-gp-sample"><p class="caption">
Figure&nbsp;2: Sample from a Gaussian Process
</p><p>A collection of 100 points of function <span class="math inline">\(f(x)\)</span> sampled from a Gaussian Process with zero mean and squared exponential kernel for the set of 100 indexes <span class="math inline">\(x =(0,0.1,0.2,\ldots,10)\)</span>.</p>
</section>
<section id="gaussian-process-demo-2" class="slide level2">
<h2>Gaussian Process Demo</h2>
<p>Let’s generate a few more samples from the same GP and plot them together</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a></a>Ys <span class="ot">=</span> <span class="fu">mvrnorm</span>(<span class="dv">3</span>, mean, cov_mat)</span>
<span id="cb6-2"><a></a><span class="fu">matplot</span>(x, <span class="fu">t</span>(Ys), <span class="at">type=</span><span class="st">"l"</span>, <span class="at">ylab=</span><span class="st">"Y"</span>, <span class="at">lwd=</span><span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>

</div>
<img data-src="05-sp_files/figure-revealjs/fig-gp-samples-1.png" width="960" class="r-stretch quarto-figure-center" id="fig-gp-samples"><p class="caption">
Figure&nbsp;3: Samples from a Gaussian Process
</p></section>
<section id="making-predictions-with-gaussian-processes" class="slide level2">
<h2>Making Predictions with Gaussian Processes</h2>
<ul>
<li>Assuming input indexes <span class="math inline">\(X = (x_1,\ldots,x_n)\)</span> and outputs <span class="math inline">\(Y = (y_1,\ldots,y_n)\)</span> are a realization of a Gaussian Process</li>
<li>Can we predict at new inputs <span class="math inline">\(x_* \in \mathbb{R}^q\)</span>. The joint distribution of the observed data <span class="math inline">\(Y\)</span> and the new data <span class="math inline">\(y_*\)</span> is given by <span class="math display">\[
\begin{bmatrix} Y \\ y_* \end{bmatrix} \sim \mathcal{N} \left ( \begin{bmatrix} \mu \\ \mu_* \end{bmatrix}, \begin{bmatrix} K &amp; K_* \\ K_*^T &amp; K_{**} \end{bmatrix} \right )
\]</span> where <span class="math inline">\(K = k(X, X)\in \mathbb{R}^{n\times n}\)</span>, <span class="math inline">\(K_* = k(X, x_*)\in \mathbb{R}^{n\times q}\)</span>, <span class="math inline">\(K_{**} = k(x_*, x_*) \in \mathbb{R}^{q\times q}\)</span>, <span class="math inline">\(\mu = \mathbb{E}[Y]\)</span>, and <span class="math inline">\(\mu_* = \mathbb{E}[y_*]\)</span>. The conditional distribution of <span class="math inline">\(y_*\)</span> given <span class="math inline">\(y\)</span> is then given by <span class="math display">\[
y_* \mid Y \sim \mathcal{N}(\mu_{\mathrm{post}}, \Sigma_{\mathrm{post}}).
% y_* \mid Y \sim \mathcal{N}(\mu_* + K_* K^{-1} (y - \mu), K_{**} - K_*^T K^{-1} K_*).
\]</span></li>
</ul>
</section>
<section id="making-predictions-with-gaussian-processes-1" class="slide level2">
<h2>Making Predictions with Gaussian Processes</h2>
<p>The mean of the conditional distribution is given by <span id="eq-mupost"><span class="math display">\[
\mu_{\mathrm{post}} = \mu_* + K_*^TK^{-1} (Y - \mu)
\qquad(1)\]</span></span> and the covariance is given by <span id="eq-Spost"><span class="math display">\[
\Sigma_{\mathrm{post}} = K_{**} - K_*^T K^{-1} K_*.
\qquad(2)\]</span></span></p>
<p><a href="#/eq-mupost" class="quarto-xref">Equation&nbsp;1</a> and <a href="#/eq-Spost" class="quarto-xref">Equation&nbsp;2</a> are convenient properties of a <a href="https://en.wikipedia.org/wiki/Multivariate_normal_distribution">multivariate normal distribution</a>.</p>
</section>
<section id="gaussian-process-for-sin-function" class="slide level2">
<h2>Gaussian Process for <span class="math inline">\(\sin\)</span> function</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a></a>n <span class="ot">=</span> <span class="dv">8</span>; eps<span class="ot">=</span><span class="fl">1e-6</span></span>
<span id="cb7-2"><a></a>X <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">2</span><span class="sc">*</span>pi, <span class="at">length=</span>n), <span class="at">ncol=</span><span class="dv">1</span>)</span>
<span id="cb7-3"><a></a>Y <span class="ot">=</span> <span class="fu">sin</span>(X)</span>
<span id="cb7-4"><a></a>K <span class="ot">=</span> <span class="fu">outer</span>(X[,<span class="dv">1</span>],X[,<span class="dv">1</span>], sqexpcov) <span class="sc">+</span> <span class="fu">diag</span>(eps, n)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>The additive term <code>diag(eps, n)</code> <span class="math inline">\(=\epsilon I\)</span> adds a diagonal matrix with the small <span class="math inline">\(\epsilon\)</span> on the diagonal.</li>
</ul>
<p>Why?</p>
</section>
<section id="gaussian-process-for-sin-function-1" class="slide level2">
<h2>Gaussian Process for <span class="math inline">\(\sin\)</span> function</h2>
<p>Now we generate a new set of inputs <span class="math inline">\(x_*\)</span> and calculate the covariance matrices <span class="math inline">\(K_*\)</span> and <span class="math inline">\(K_{**}\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a></a>q <span class="ot">=</span> <span class="dv">100</span></span>
<span id="cb8-2"><a></a>XX <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">seq</span>(<span class="sc">-</span><span class="fl">0.5</span>, <span class="dv">2</span><span class="sc">*</span>pi <span class="sc">+</span> <span class="fl">0.5</span>, <span class="at">length=</span>q), <span class="at">ncol=</span><span class="dv">1</span>)</span>
<span id="cb8-3"><a></a>KX <span class="ot">=</span> <span class="fu">outer</span>(X[,<span class="dv">1</span>], XX[,<span class="dv">1</span>],sqexpcov)</span>
<span id="cb8-4"><a></a>KXX <span class="ot">=</span> <span class="fu">outer</span>(XX[,<span class="dv">1</span>],XX[,<span class="dv">1</span>], sqexpcov) <span class="sc">+</span> <span class="fu">diag</span>(eps, q)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Notice, we did not add <span class="math inline">\(\epsilon I\)</span> to <span class="math inline">\(K_*\)</span> = <code>KX</code> matrix, but to add it to <span class="math inline">\(K_{**}\)</span> = <code>KXX</code> to guarantee that the resulting posterior covariance matrix is non-singular (invert able).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a></a>Si <span class="ot">=</span> <span class="fu">solve</span>(K)</span>
<span id="cb9-2"><a></a>mup <span class="ot">=</span> <span class="fu">t</span>(KX) <span class="sc">%*%</span> Si <span class="sc">%*%</span> Y <span class="co"># we assume mu is 0</span></span>
<span id="cb9-3"><a></a>Sigmap <span class="ot">=</span> KXX <span class="sc">-</span> <span class="fu">t</span>(KX) <span class="sc">%*%</span> Si <span class="sc">%*%</span> KX</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="gaussian-process-for-sin-function-2" class="slide level2">
<h2>Gaussian Process for <span class="math inline">\(\sin\)</span> function</h2>
<p>Now, we can generate a sample from the posterior distribution over <span class="math inline">\(y_*\)</span>, given <span class="math inline">\(Y\)</span></p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a></a>plot_gp <span class="ot">=</span> <span class="cf">function</span>(mup, Sigmap, X, Y, XX, YY){</span>
<span id="cb10-2"><a></a>  q1 <span class="ot">=</span> mup <span class="sc">+</span> <span class="fu">qnorm</span>(<span class="fl">0.05</span>, <span class="dv">0</span>, <span class="fu">sqrt</span>(<span class="fu">diag</span>(Sigmap)))</span>
<span id="cb10-3"><a></a>  q2 <span class="ot">=</span> mup <span class="sc">+</span> <span class="fu">qnorm</span>(<span class="fl">0.95</span>, <span class="dv">0</span>, <span class="fu">sqrt</span>(<span class="fu">diag</span>(Sigmap)))</span>
<span id="cb10-4"><a></a>  <span class="fu">matplot</span>(XX, <span class="fu">t</span>(YY), <span class="at">type=</span><span class="st">"l"</span>, <span class="at">col=</span><span class="st">"gray"</span>, <span class="at">lty=</span><span class="dv">1</span>, <span class="at">xlab=</span><span class="st">"x"</span>, <span class="at">ylab=</span><span class="st">"y"</span>)</span>
<span id="cb10-5"><a></a>  <span class="fu">points</span>(X, Y, <span class="at">pch=</span><span class="dv">20</span>, <span class="at">cex=</span><span class="dv">2</span>)</span>
<span id="cb10-6"><a></a>  <span class="fu">lines</span>(XX, <span class="fu">sin</span>(XX), <span class="at">col=</span><span class="st">"blue"</span>)</span>
<span id="cb10-7"><a></a>  <span class="fu">lines</span>(XX, mup, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb10-8"><a></a>  <span class="fu">lines</span>(XX, q1, <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">lty=</span><span class="dv">2</span>, <span class="at">col=</span><span class="dv">2</span>)</span>
<span id="cb10-9"><a></a>  <span class="fu">lines</span>(XX, q2, <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">lty=</span><span class="dv">2</span>, <span class="at">col=</span><span class="dv">2</span>)</span>
<span id="cb10-10"><a></a>}</span>
<span id="cb10-11"><a></a>YY <span class="ot">=</span> <span class="fu">mvrnorm</span>(<span class="dv">100</span>, mup, Sigmap)</span>
<span id="cb10-12"><a></a><span class="fu">plot_gp</span>(mup, Sigmap, X, Y, XX, YY)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>

</div>
<img data-src="05-sp_files/figure-revealjs/unnamed-chunk-9-1.png" width="960" class="r-stretch"></section>
<section id="mle-for-gaussian-process" class="slide level2">
<h2>MLE for Gaussian Process</h2>
<ul>
<li>Use the observed data to estimate those to parameters.</li>
<li>In the context of GP models, they are call hyper-parameters.</li>
</ul>
<p>Likelihood: <span class="math display">\[
p(Y \mid X, \sigma, l) = \frac{1}{(2\pi)^{n/2} |K|^{1/2}} \exp \left ( -\frac{1}{2} Y^T K^{-1} Y \right )
\]</span> where <span class="math inline">\(K = K(X,X)\)</span> is the covariance matrix. We assume mean is zero, to simplify the formulas. The log-likelihood is given by <span class="math display">\[
\log p(Y \mid X, \sigma, l) = -\frac{1}{2} \log |K| - \frac{1}{2} Y^T K^{-1} Y - \frac{n}{2} \log 2\pi.
\]</span></p>
</section>
<section id="mle-for-gaussian-process-1" class="slide level2">
<h2>MLE for Gaussian Process</h2>
<p>Let’s implement a function that calculates the log-likelihood of the data given the hyper-parameters <span class="math inline">\(\sigma\)</span> and <span class="math inline">\(l\)</span> and use <code>optim</code> function to find the maximum of the log-likelihood function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a></a>loglik <span class="ot">=</span> <span class="cf">function</span>(par, X, Y) {</span>
<span id="cb11-2"><a></a>  sigma <span class="ot">=</span> par[<span class="dv">1</span>]</span>
<span id="cb11-3"><a></a>  l <span class="ot">=</span> par[<span class="dv">2</span>]</span>
<span id="cb11-4"><a></a>  K <span class="ot">=</span> <span class="fu">outer</span>(X[,<span class="dv">1</span>],X[,<span class="dv">1</span>], sqexpcov,l,sigma) <span class="sc">+</span> <span class="fu">diag</span>(eps, n)</span>
<span id="cb11-5"><a></a>  Si <span class="ot">=</span> <span class="fu">solve</span>(K)</span>
<span id="cb11-6"><a></a>  <span class="fu">return</span>(<span class="sc">-</span>(<span class="sc">-</span><span class="fl">0.5</span> <span class="sc">*</span> <span class="fu">log</span>(<span class="fu">det</span>(K)) <span class="sc">-</span> <span class="fl">0.5</span> <span class="sc">*</span> <span class="fu">t</span>(Y) <span class="sc">%*%</span> Si <span class="sc">%*%</span> Y <span class="sc">-</span> (n<span class="sc">/</span><span class="dv">2</span>)<span class="sc">*</span> <span class="fu">log</span>(<span class="dv">2</span><span class="sc">*</span>pi)))</span>
<span id="cb11-7"><a></a>}</span>
<span id="cb11-8"><a></a>par <span class="ot">=</span> <span class="fu">optim</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>), loglik, <span class="at">X=</span>X, <span class="at">Y=</span>Y)<span class="sc">$</span>par</span>
<span id="cb11-9"><a></a><span class="fu">print</span>(par)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.502246 2.398773</code></pre>
</div>
</div>
</section>
<section id="mle-for-gaussian-process-2" class="slide level2">
<h2>MLE for Gaussian Process</h2>
<p>Make predictions about the output values at new inputs <span class="math inline">\(x_*\)</span>.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a></a>l <span class="ot">=</span> par[<span class="dv">2</span>]; sigma <span class="ot">=</span> par[<span class="dv">1</span>]</span>
<span id="cb13-2"><a></a>predplot <span class="ot">=</span> <span class="cf">function</span>(X, Y, XX, YY, l, sigma) {</span>
<span id="cb13-3"><a></a>  K <span class="ot">=</span> <span class="fu">outer</span>(X[,<span class="dv">1</span>],X[,<span class="dv">1</span>], sqexpcov,l,sigma) <span class="sc">+</span> <span class="fu">diag</span>(eps, n)</span>
<span id="cb13-4"><a></a>  KX <span class="ot">=</span> <span class="fu">outer</span>(X[,<span class="dv">1</span>], XX[,<span class="dv">1</span>],sqexpcov,l,sigma)</span>
<span id="cb13-5"><a></a>  KXX <span class="ot">=</span> <span class="fu">outer</span>(XX[,<span class="dv">1</span>],XX[,<span class="dv">1</span>], sqexpcov,l,sigma) <span class="sc">+</span> <span class="fu">diag</span>(eps, q)</span>
<span id="cb13-6"><a></a>  Si <span class="ot">=</span> <span class="fu">solve</span>(K)</span>
<span id="cb13-7"><a></a>  mup <span class="ot">=</span> <span class="fu">t</span>(KX) <span class="sc">%*%</span> Si <span class="sc">%*%</span> Y <span class="co"># we assume mu is 0</span></span>
<span id="cb13-8"><a></a>  Sigmap <span class="ot">=</span> KXX <span class="sc">-</span> <span class="fu">t</span>(KX) <span class="sc">%*%</span> Si <span class="sc">%*%</span> KX</span>
<span id="cb13-9"><a></a>  YY <span class="ot">=</span> <span class="fu">mvrnorm</span>(<span class="dv">100</span>, mup, Sigmap)</span>
<span id="cb13-10"><a></a>  <span class="fu">plot_gp</span>(mup, Sigmap, X, Y, XX, YY)</span>
<span id="cb13-11"><a></a>}</span>
<span id="cb13-12"><a></a><span class="fu">predplot</span>(X, Y, XX, YY, l, sigma)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>

</div>
<img data-src="05-sp_files/figure-revealjs/unnamed-chunk-10-1.png" width="960" class="r-stretch"><p>We can see that our uncertainty is much “tighter”</p>
</section>
<section id="log-likelihood-derivative" class="slide level2">
<h2>Log-likelihood Derivative</h2>
<p>Some matrix calculus: <span class="math display">\[
\frac{\partial  Y^T K^{-1} Y}{\partial \theta} =  Y^T \frac{\partial K^{-1}}{\partial \theta} Y.
\]</span> The derivative of the inverse matrix <span class="math display">\[
\frac{\partial K^{-1}}{\partial \theta} = -K^{-1} \frac{\partial K}{\partial \theta} K^{-1}.
\]</span> and the log of the determinant of a matrix <span class="math display">\[
\frac{\partial \log |K|}{\partial \theta} = \mathrm{tr} \left ( K^{-1} \frac{\partial K}{\partial \theta} \right ),
\]</span></p>
</section>
<section id="log-likelihood-derivative-1" class="slide level2">
<h2>Log-likelihood Derivative</h2>
<p>Calculate the derivative of the log-likelihood function with respect to <span class="math inline">\(\theta\)</span> <span class="math display">\[
\frac{\partial \log p(Y \mid X,\theta)}{\partial \theta} = -\frac{1}{2}\frac{\partial \log |K|}{\partial \theta}  + \frac{1}{2} Y^T \frac{\partial K^{-1}}{\partial \theta}  Y.
\]</span> Putting it all together, we get <span class="math display">\[
\frac{\partial \log p(Y \mid X,\theta)}{\partial \theta} = -\frac{1}{2} \mathrm{tr} \left ( K^{-1} \frac{\partial K}{\partial \theta} \right ) + \frac{1}{2} Y^T K^{-1} \frac{\partial K}{\partial \theta} K^{-1} Y.
\]</span></p>
</section>
<section id="log-likelihood-derivative-for-squared-exponential-kernel" class="slide level2">
<h2>Log-likelihood Derivative for squared exponential kernel</h2>
<p><span class="math display">\[
K_{ij} = k(x_i, x_j) = \sigma^2 \exp \left ( -\frac{1}{2} \frac{(x_i - x_j)^2}{l^2} \right ).
\]</span> The derivative of the covariance matrix with respect to <span class="math inline">\(\sigma\)</span> is given by <span class="math display">\[
\frac{\partial K_{ij}}{\partial \sigma} = 2\sigma \exp \left ( -\frac{1}{2} \frac{(x_i - x_j)^2}{l^2} \right );~\frac{\partial K}{\partial \sigma} = \dfrac{2}{\sigma}K.
\]</span> The derivative of the covariance matrix with respect to <span class="math inline">\(l\)</span> is given by <span class="math display">\[
\frac{\partial K_{ij}}{\partial l} = \sigma^2 \exp \left ( -\frac{1}{2} \frac{(x_i - x_j)^2}{l^2} \right ) \frac{(x_i - x_j)^2}{l^3};~ \frac{\partial K}{\partial l}  = \frac{(x_i - x_j)^2}{l^3} K.
\]</span></p>
</section>
<section id="log-likelihood-derivative-2" class="slide level2">
<h2>Log-likelihood Derivative</h2>
<p>Now we can implement a function that calculates the derivative of the log-likelihood function with respect to <span class="math inline">\(\sigma\)</span> and <span class="math inline">\(l\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a></a><span class="co"># Derivative of the log-likelihood function with respect to sigma</span></span>
<span id="cb14-2"><a></a>dloglik_sigma <span class="ot">=</span> <span class="cf">function</span>(par, X, Y) {</span>
<span id="cb14-3"><a></a>  sigma <span class="ot">=</span> par[<span class="dv">1</span>]; l <span class="ot">=</span> par[<span class="dv">2</span>]</span>
<span id="cb14-4"><a></a>  K <span class="ot">=</span> <span class="fu">outer</span>(X[,<span class="dv">1</span>],X[,<span class="dv">1</span>], sqexpcov,l,sigma) <span class="sc">+</span> <span class="fu">diag</span>(eps, n)</span>
<span id="cb14-5"><a></a>  Si <span class="ot">=</span> <span class="fu">solve</span>(K)</span>
<span id="cb14-6"><a></a>  dK <span class="ot">=</span> <span class="dv">2</span><span class="sc">*</span>K<span class="sc">/</span>sigma</span>
<span id="cb14-7"><a></a>  tr <span class="ot">=</span> <span class="fu">sum</span>(<span class="fu">diag</span>(Si <span class="sc">%*%</span> dK))</span>
<span id="cb14-8"><a></a>  <span class="fu">return</span>(<span class="sc">-</span>(<span class="sc">-</span><span class="fl">0.5</span> <span class="sc">*</span> tr <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> <span class="fu">t</span>(Y) <span class="sc">%*%</span> Si <span class="sc">%*%</span> dK <span class="sc">%*%</span> Si <span class="sc">%*%</span> Y))</span>
<span id="cb14-9"><a></a>}</span>
<span id="cb14-10"><a></a><span class="co"># Derivative of the log-likelihood function with respect to l</span></span>
<span id="cb14-11"><a></a>dloglik_l <span class="ot">=</span> <span class="cf">function</span>(par, X, Y) {</span>
<span id="cb14-12"><a></a>  sigma <span class="ot">=</span> par[<span class="dv">1</span>]; l <span class="ot">=</span> par[<span class="dv">2</span>]</span>
<span id="cb14-13"><a></a>  K <span class="ot">=</span> <span class="fu">outer</span>(X[,<span class="dv">1</span>],X[,<span class="dv">1</span>], sqexpcov ,l,sigma) <span class="sc">+</span> <span class="fu">diag</span>(eps, n)</span>
<span id="cb14-14"><a></a>  Si <span class="ot">=</span> <span class="fu">solve</span>(K)</span>
<span id="cb14-15"><a></a>  dK <span class="ot">=</span>   <span class="fu">outer</span>(X[,<span class="dv">1</span>],X[,<span class="dv">1</span>], <span class="cf">function</span>(x, x1) (x <span class="sc">-</span> x1)<span class="sc">^</span><span class="dv">2</span>)<span class="sc">/</span>l<span class="sc">^</span><span class="dv">3</span> <span class="sc">*</span> K</span>
<span id="cb14-16"><a></a>  tr <span class="ot">=</span> <span class="fu">sum</span>(<span class="fu">diag</span>(Si <span class="sc">%*%</span> dK))</span>
<span id="cb14-17"><a></a>  <span class="fu">return</span>(<span class="sc">-</span>(<span class="sc">-</span><span class="fl">0.5</span> <span class="sc">*</span> tr <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> <span class="fu">t</span>(Y) <span class="sc">%*%</span> Si <span class="sc">%*%</span> dK <span class="sc">%*%</span> Si <span class="sc">%*%</span> Y))</span>
<span id="cb14-18"><a></a>}</span>
<span id="cb14-19"><a></a><span class="co"># Gradient function that returns a vector of derivatives</span></span>
<span id="cb14-20"><a></a>gnlg <span class="ot">=</span> <span class="cf">function</span>(par,X,Y) {</span>
<span id="cb14-21"><a></a>  <span class="fu">return</span>(<span class="fu">c</span>(<span class="fu">dloglik_sigma</span>(par, X, Y), <span class="fu">dloglik_l</span>(par, X, Y)))</span>
<span id="cb14-22"><a></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="log-likelihood-derivative-3" class="slide level2">
<h2>Log-likelihood Derivative</h2>
<p>Now we can use the <code>optim</code> function to find the maximum of the log-likelihood function and provide the derivative function we just implemented.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a></a>par1 <span class="ot">=</span> <span class="fu">optim</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>), <span class="at">fn=</span>loglik, <span class="at">gr=</span>gnlg ,<span class="at">X=</span>X, <span class="at">Y=</span>Y,<span class="at">method=</span><span class="st">"BFGS"</span>)<span class="sc">$</span>par</span>
<span id="cb15-2"><a></a>l <span class="ot">=</span> par1[<span class="dv">2</span>]; sigma <span class="ot">=</span> par1[<span class="dv">1</span>]</span>
<span id="cb15-3"><a></a><span class="fu">print</span>(par1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.48443 2.39151</code></pre>
</div>
</div>
<p>The result is the same compared to when we called <code>optim</code> without the derivative function. Even execution time is the same for our small problem. However, at larger scale, the derivative-based optimization algorithm will be much faster.</p>
</section>
<section id="use-r-package-for-gaussian-processes" class="slide level2">
<h2>Use <code>R</code> Package for Gaussian Processes</h2>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a></a><span class="fu">library</span>(laGP)</span>
<span id="cb17-2"><a></a>gp <span class="ot">=</span> <span class="fu">newGP</span>(X, Y, <span class="dv">1</span>, <span class="dv">0</span>, <span class="at">dK =</span> <span class="cn">TRUE</span>)</span>
<span id="cb17-3"><a></a>res <span class="ot">=</span> <span class="fu">mleGP</span>(gp, <span class="at">tmax=</span><span class="dv">20</span>)</span>
<span id="cb17-4"><a></a>l.laGP <span class="ot">=</span> <span class="fu">sqrt</span>(res<span class="sc">$</span>d<span class="sc">/</span><span class="dv">2</span>)</span>
<span id="cb17-5"><a></a><span class="fu">print</span>(l.laGP)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2.36025</code></pre>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a></a><span class="fu">predplot</span>(X, Y, XX, YY, l, sigma)</span>
<span id="cb19-2"><a></a><span class="fu">predplot</span>(X, Y, XX, YY, l.laGP, <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="fig-gp-sin-mle" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig">
<div aria-describedby="fig-gp-sin-mle-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-gp-sin-mle" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-gp-sin-mle-1" class="quarto-float quarto-figure quarto-figure-center">
<figure class="quarto-float quarto-subfloat-fig">
<div aria-describedby="fig-gp-sin-mle-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img data-src="05-sp_files/figure-revealjs/fig-gp-sin-mle-1.png" data-ref-parent="fig-gp-sin-mle" width="960">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-gp-sin-mle-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) MLE Fit
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-gp-sin-mle" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-gp-sin-mle-2" class="quarto-float quarto-figure quarto-figure-center">
<figure class="quarto-float quarto-subfloat-fig">
<div aria-describedby="fig-gp-sin-mle-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img data-src="05-sp_files/figure-revealjs/fig-gp-sin-mle-2.png" data-ref-parent="fig-gp-sin-mle" width="960">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-gp-sin-mle-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) laGP Fit
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-gp-sin-mle-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: Posterior distribution over <span class="math inline">\(y_*\)</span>, given <span class="math inline">\(Y\)</span>
</figcaption>
</figure>
</div>
</section>
<section id="prediction" class="slide level2">
<h2>Prediction</h2>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a></a>XX1 <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">seq</span>(<span class="sc">-</span><span class="dv">4</span><span class="sc">*</span>pi, <span class="dv">6</span><span class="sc">*</span>pi <span class="sc">+</span> <span class="fl">0.5</span>, <span class="at">length=</span>q), <span class="at">ncol=</span><span class="dv">1</span>)</span>
<span id="cb20-2"><a></a><span class="fu">predplot</span>(X, Y, XX1, YY, l, sigma)</span>
<span id="cb20-3"><a></a><span class="fu">predplot</span>(X, Y, XX1, YY, l.laGP, <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="05-sp_files/figure-revealjs/unnamed-chunk-14-1.png" width="960"></p>
<figcaption>MLE Fit</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="05-sp_files/figure-revealjs/unnamed-chunk-14-2.png" width="960"></p>
<figcaption>laGP Fit</figcaption>
</figure>
</div>
</div>
</div>
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<p>Extrapolation: Posterior distribution over <span class="math inline">\(y_*\)</span>, given <span class="math inline">\(Y\)</span></p>
</div>
</div>
</div>
<p>We can see that outside of the range of the observed data, the model with <span class="math inline">\(\sigma=1\)</span> is more “confident” in its predictions.</p>
</section>
<section id="gaussian-process-for-motorcycle-accident-data" class="slide level2">
<h2>Gaussian Process for Motorcycle Accident Data</h2>
<p>We first estimate the length scale parameter <span class="math inline">\(l\)</span> using the <code>laGP</code> package.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a></a><span class="fu">library</span>(MASS)</span>
<span id="cb21-2"><a></a><span class="fu">library</span>(laGP)</span>
<span id="cb21-3"><a></a>X <span class="ot">=</span> mcycle<span class="sc">$</span>times</span>
<span id="cb21-4"><a></a>Y <span class="ot">=</span> mcycle<span class="sc">$</span>accel</span>
<span id="cb21-5"><a></a>gp <span class="ot">=</span> <span class="fu">newGP</span>(<span class="fu">matrix</span>(X), Y, <span class="dv">2</span>, <span class="fl">1e-6</span>, <span class="at">dK =</span> <span class="cn">TRUE</span>);</span>
<span id="cb21-6"><a></a><span class="fu">mleGP</span>(gp, <span class="at">tmax=</span><span class="dv">10</span>);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now we plot the data and the fit using the estimated length scale parameter <span class="math inline">\(l\)</span>.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb22-2"><a></a>XX <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">seq</span>(<span class="fl">2.4</span>, <span class="dv">55</span>, <span class="at">length =</span> <span class="dv">499</span>), <span class="at">ncol=</span><span class="dv">1</span>)</span>
<span id="cb22-3"><a></a>p <span class="ot">=</span> <span class="fu">predGP</span>(gp, XX)</span>
<span id="cb22-4"><a></a>N <span class="ot">=</span> <span class="dv">499</span></span>
<span id="cb22-5"><a></a>q1 <span class="ot">=</span> <span class="fu">qnorm</span>(<span class="fl">0.05</span>, <span class="at">mean =</span> p<span class="sc">$</span>mean, <span class="at">sd =</span> <span class="fu">sqrt</span>(<span class="fu">diag</span>(p<span class="sc">$</span>Sigma)))</span>
<span id="cb22-6"><a></a>q2 <span class="ot">=</span> <span class="fu">qnorm</span>(<span class="fl">0.95</span>, <span class="at">mean =</span> p<span class="sc">$</span>mean, <span class="at">sd =</span> <span class="fu">sqrt</span>(<span class="fu">diag</span>(p<span class="sc">$</span>Sigma)))</span>
<span id="cb22-7"><a></a>q3 <span class="ot">=</span> <span class="fu">qnorm</span>(<span class="fl">0.5</span>, <span class="at">mean =</span> p<span class="sc">$</span>mean, <span class="at">sd =</span> <span class="fu">sqrt</span>(<span class="fu">diag</span>(p<span class="sc">$</span>Sigma)))</span>
<span id="cb22-8"><a></a><span class="fu">ggplot</span>() <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x=</span>X,<span class="at">y=</span>Y)) <span class="sc">+</span> <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span>XX,<span class="at">y=</span>q3)) <span class="sc">+</span> <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">x=</span>XX,<span class="at">ymin=</span>q1, <span class="at">ymax=</span>q2), <span class="at">alpha=</span><span class="fl">0.2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>

</div>
<img data-src="05-sp_files/figure-revealjs/unnamed-chunk-16-1.png" width="960" class="r-stretch quarto-figure-center"><p class="caption">Motorcycle Accident Data. Black line is the mean of the posterior distribution over <span class="math inline">\(y_*\)</span>, given <span class="math inline">\(Y\)</span>. Blue lines are the 95% confidence interval.</p></section>
<section id="gaussian-process-for-motorcycle-accident-data-1" class="slide level2">
<h2>Gaussian Process for Motorcycle Accident Data</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a></a><span class="fu">hist</span>(X)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>

</div>
<img data-src="05-sp_files/figure-revealjs/unnamed-chunk-17-1.png" width="960" class="r-stretch quarto-figure-center"><p class="caption">Histogram of time values</p><p>The <span class="math inline">\(\sqrt{n}\)</span> decay in variance of the posterior distribution is a property of the squared exponential kernel.</p>
</section></section>
<section>
<section id="bayesian-optimisation" class="title-slide slide level1 center">
<h1>Bayesian Optimisation</h1>

</section>
<section id="definition-1" class="slide level2">
<h2>Definition</h2>
<ul>
<li>Bayesian optimization is a sequential design strategy for global optimization of black-box functions.</li>
<li>It is particularly well-suited for optimization of high-cost functions, situations where the number of function evaluations is limited, and noisy evaluations.</li>
<li>The goal is to find the global minimum of an unknown function <span class="math inline">\(f(x)\)</span>, where <span class="math inline">\(x \in \mathbb{R}^d\)</span>.</li>
<li>The function is assumed to be a black-box, i.e., we can evaluate it at any point <span class="math inline">\(x\)</span> but we do not have access to its analytical form.</li>
</ul>
</section>
<section id="basic-idea" class="slide level2">
<h2>Basic Idea</h2>
<div class="cell" data-reveal="true" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode numberSource default number-lines code-with-copy"><code class="sourceCode default"><span id="cb24-1"><a></a>graph LR</span>
<span id="cb24-2"><a></a>    NS[Decision on Next Samples]--Collect--&gt;S[System Under Study]</span>
<span id="cb24-3"><a></a>    S--Observe--&gt;NS</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<p></p><figure class=""><p></p>
<div>
<pre class="mermaid mermaid-js">graph LR
    NS[Decision on Next Samples]--Collect--&gt;S[System Under Study]
    S--Observe--&gt;NS
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<ul>
<li>Multi-Armed Bandits</li>
<li>Q-Learning</li>
<li>Active Learning</li>
<li>Reinforcement Learning</li>
<li>Bayesian Optimization</li>
</ul>
</section>
<section id="bayesian-optimization" class="slide level2 scrollable">
<h2>Bayesian Optimization</h2>
<p>Given a function <span class="math inline">\(f(x)\)</span>, that is not known analytically, it can represent, for example, output of a complex computer program. The goal is to optimize <span class="math display">\[
x^* = \arg\min_x f(x).
\]</span></p>
<p>The Bayesian approach to this problem is the following:</p>
<ol type="1">
<li>Define a prior distribution over <span class="math inline">\(f(x)\)</span></li>
<li>Calculate <span class="math inline">\(f\)</span> at a few points <span class="math inline">\(x_1, \ldots, x_n\)</span></li>
<li>Repeat until convergence:
<ol type="1">
<li>Update the prior to get the posterior distribution over <span class="math inline">\(f(x)\)</span></li>
<li>Choose the next point <span class="math inline">\(x^+\)</span> to evaluate <span class="math inline">\(f(x)\)</span></li>
<li>Calculate <span class="math inline">\(f(x^+)\)</span></li>
</ol></li>
<li>Pick <span class="math inline">\(x^*\)</span> that corresponds to the smallest value of <span class="math inline">\(f(x)\)</span> among evaluated points</li>
</ol>
</section>
<section id="where-to-sample-next" class="slide level2">
<h2>Where to sample next?</h2>
<p>The <em>expected improvement</em> (EI) acquisition function <span class="math display">\[
f^* = \min y
\]</span> Our current best. At a given point <span class="math inline">\(x\)</span> and function value <span class="math inline">\(y = f(x)\)</span>, the expected improvement function is defined as <span class="math display">\[
a(x) = \mathbb{E}\left[\max(0, f^* - y)\right],
\]</span> The function that we calculate expectation of <span class="math display">\[
u(x) = \max(0, f^* - y)
\]</span> is the utility function. Thus, the acquisition function is the expected value of the utility function.</p>
</section>
<section id="acquisition-function" class="slide level2">
<h2>Acquisition function</h2>
<ul>
<li>Given GP approximation for <span class="math inline">\(f\)</span>, we can calculate the acquisition function analytically.</li>
<li>The posterior distribution of Normal <span class="math inline">\(f(x)\mid x \sim N(\mu,\sigma^2)\)</span>, then the acquisition function is <span class="math display">\[\begin{align*}
a(x) &amp;= \mathbb{E}\left[\max(0, f^* - y)\right] \\
&amp;= \int_{-\infty}^{\infty} \max(0, f^* - y) \phi(y,\mu,\sigma^2) dy \\
&amp;= \int_{-\infty}^{f^*} (f^* - y) \phi(y,\mu,\sigma^2) dy
\end{align*}\]</span> where <span class="math inline">\(\phi(y,\mu,\sigma^2)\)</span> is the probability density function of the normal distribution. A useful identity is</li>
</ul>
</section>
<section id="acquisition-function-1" class="slide level2">
<h2>Acquisition function</h2>
<p><span class="math display">\[
\int y \phi(y,\mu,\sigma^2) dy =\frac{1}{2} \mu  \text{erf}\left(\frac{y-\mu }{\sqrt{2} \sigma }\right)-\frac{\sigma
   e^{-\frac{(y-\mu )^2}{2 \sigma ^2}}}{\sqrt{2 \pi }},
\]</span> where <span class="math inline">\(\Phi(y,\mu,\sigma^2)\)</span> is the cumulative distribution function of the normal distribution. Thus, <span class="math display">\[
\int_{-\infty}^{f^*} y \phi(y,\mu,\sigma^2) dy = \frac{1}{2} \mu (1+\text{erf}\left(\frac{f^*-\mu }{\sqrt{2} \sigma
   }\right))-\frac{\sigma  e^{-\frac{(f^*-\mu )^2}{2 \sigma ^2}}}{\sqrt{2 \pi}} = \mu \Phi(f^*,\mu,\sigma^2) + \sigma^2 \phi(f^*,\mu,\sigma^2).
\]</span></p>
<p>we can write the acquisition function as <span class="math display">\[
a(x) = \dfrac{1}{2}\left(\sigma^2 \phi(f^*,\mu,\sigma^2) + (f^*-\mu)\Phi(f^*,\mu,\sigma^2)\right)
\]</span></p>
</section>
<section id="acquisition-function-2" class="slide level2">
<h2>Acquisition function</h2>
<p>Let’s implement it</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a></a>acq <span class="ot">&lt;-</span> <span class="cf">function</span>(xx,p, fstar) {</span>
<span id="cb25-2"><a></a>  x <span class="ot">=</span> <span class="fu">matrix</span>(xx, <span class="at">ncol=</span><span class="dv">1</span>)</span>
<span id="cb25-3"><a></a>  d <span class="ot">=</span> fstar <span class="sc">-</span> p<span class="sc">$</span>mean</span>
<span id="cb25-4"><a></a>  s <span class="ot">=</span> <span class="fu">sqrt</span>(<span class="fu">diag</span>(p<span class="sc">$</span>Sigma))</span>
<span id="cb25-5"><a></a>  <span class="fu">return</span>(s<span class="sc">*</span><span class="fu">dnorm</span>(d) <span class="sc">+</span> d<span class="sc">*</span><span class="fu">pnorm</span>(d))</span>
<span id="cb25-6"><a></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="taxi-fleet-optimisation" class="slide level2">
<h2>Taxi Fleet Optimisation</h2>
<ul>
<li>Black box: taxi fleet simulator from <a href="https://github.com/amzn/emukit-playground">Emukit project</a>.</li>
<li>Input: fleet size</li>
<li>Simulates the taxi fleet operations and calculates the profit.</li>
</ul>

<img data-src="./figup//emukit-taxi.png" style="width:80.0%" class="r-stretch quarto-figure-center"><p class="caption">Taxi Simulator Visualization</p></section>
<section id="taxi-fleet-optimisation-1" class="slide level2">
<h2>Taxi Fleet Optimisation</h2>
<ul>
<li>We start with initial set of three designs <span class="math inline">\(x = (10,30,90)\)</span>, where <span class="math inline">\(x\)</span> is the number of the taxis in</li>
<li>Observe profit=(3.1,3.6,6.6)</li>
</ul>
<p>Define a helper function to plot the GP emulator</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a></a>plotgp <span class="ot">=</span> <span class="cf">function</span>(x,y,XX,p) {</span>
<span id="cb26-2"><a></a>  q1 <span class="ot">=</span> <span class="fu">qnorm</span>(<span class="fl">0.05</span>, <span class="at">mean =</span> p<span class="sc">$</span>mean, <span class="at">sd =</span> <span class="fu">sqrt</span>(<span class="fu">diag</span>(p<span class="sc">$</span>Sigma)))</span>
<span id="cb26-3"><a></a>  q2 <span class="ot">=</span> <span class="fu">qnorm</span>(<span class="fl">0.95</span>, <span class="at">mean =</span> p<span class="sc">$</span>mean, <span class="at">sd =</span> <span class="fu">sqrt</span>(<span class="fu">diag</span>(p<span class="sc">$</span>Sigma)))</span>
<span id="cb26-4"><a></a>  q3 <span class="ot">=</span> <span class="fu">qnorm</span>(<span class="fl">0.5</span>, <span class="at">mean =</span> p<span class="sc">$</span>mean, <span class="at">sd =</span> <span class="fu">sqrt</span>(<span class="fu">diag</span>(p<span class="sc">$</span>Sigma)))</span>
<span id="cb26-5"><a></a>  <span class="fu">ggplot</span>() <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x=</span>x,<span class="at">y=</span>y)) <span class="sc">+</span> <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span>XX,<span class="at">y=</span>q3)) <span class="sc">+</span> <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">x=</span>XX,<span class="at">ymin=</span>q1, <span class="at">ymax=</span>q2), <span class="at">alpha=</span><span class="fl">0.2</span>)</span>
<span id="cb26-6"><a></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="fit-gp" class="slide level2">
<h2>Fit GP</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a></a><span class="fu">library</span>(laGP)</span>
<span id="cb27-2"><a></a><span class="fu">library</span>(mvtnorm)</span>
<span id="cb27-3"><a></a>x <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">10</span>,<span class="dv">90</span>,<span class="dv">30</span>), <span class="at">ncol=</span><span class="dv">1</span>)</span>
<span id="cb27-4"><a></a>xx <span class="ot">=</span> <span class="fu">seq</span>(<span class="dv">1</span>,<span class="dv">100</span>, <span class="at">length=</span><span class="dv">500</span>)</span>
<span id="cb27-5"><a></a>XX <span class="ot">&lt;-</span> <span class="fu">matrix</span>(xx, <span class="at">ncol =</span> <span class="fu">ncol</span>(x))</span>
<span id="cb27-6"><a></a>profit <span class="ot">=</span> <span class="sc">-</span><span class="fu">c</span>(<span class="fl">3.1</span>,<span class="fl">3.6</span>,<span class="fl">6.6</span>)</span>
<span id="cb27-7"><a></a>gp <span class="ot">&lt;-</span> <span class="fu">newGP</span>(x, profit, <span class="dv">1000</span>, <span class="fl">1e-6</span>, <span class="at">dK =</span> <span class="cn">TRUE</span>)</span>
<span id="cb27-8"><a></a>p <span class="ot">&lt;-</span> <span class="fu">predGP</span>(gp, XX)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="plot-the-fit" class="slide level2">
<h2>Plot the Fit</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a></a><span class="fu">plotgp</span>(x,profit,XX,p)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>

</div>
<img data-src="05-sp_files/figure-revealjs/unnamed-chunk-19-1.png" width="960" class="r-stretch"><p>there is potentially a better value at around 50 taxis</p>
</section>
<section id="run-optimisation" class="slide level2">
<h2>Run Optimisation</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a></a>nextsample <span class="ot">=</span> <span class="cf">function</span>(){</span>
<span id="cb29-2"><a></a>  ei <span class="ot">=</span> <span class="fu">acq</span>(xx,p,<span class="fu">min</span>(profit))</span>
<span id="cb29-3"><a></a>  <span class="fu">plot</span>(xx,ei, <span class="at">type=</span><span class="st">'l'</span>)</span>
<span id="cb29-4"><a></a>  xnext <span class="ot">=</span> <span class="fu">as.integer</span>(xx[<span class="fu">which.max</span>(ei)])</span>
<span id="cb29-5"><a></a>  <span class="fu">return</span>(xnext)</span>
<span id="cb29-6"><a></a>}</span>
<span id="cb29-7"><a></a>updgp <span class="ot">=</span> <span class="cf">function</span>(xnext,f){</span>
<span id="cb29-8"><a></a>  profit <span class="ot">&lt;&lt;-</span> <span class="fu">c</span>(profit, f)</span>
<span id="cb29-9"><a></a>  x <span class="ot">&lt;&lt;-</span> <span class="fu">c</span>(x, xnext)</span>
<span id="cb29-10"><a></a>  <span class="fu">updateGP</span>(gp, <span class="fu">matrix</span>(xnext,<span class="at">ncol=</span><span class="dv">1</span>), f)</span>
<span id="cb29-11"><a></a>  p <span class="ot">&lt;&lt;-</span> <span class="fu">predGP</span>(gp, XX)</span>
<span id="cb29-12"><a></a>  <span class="fu">plotgp</span>(x,profit,XX,p)</span>
<span id="cb29-13"><a></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="run-optimisation-1" class="slide level2">
<h2>Run Optimisation</h2>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a></a><span class="fu">nextsample</span>(); <span class="co">#44</span></span>
<span id="cb30-2"><a></a><span class="fu">updgp</span>(<span class="dv">44</span>, <span class="sc">-</span><span class="fl">8.4</span>);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell quarto-layout-panel" data-layout="[[6,1,6], [6,1,6]]">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 46.2%;justify-content: center;">
<p><img data-src="05-sp_files/figure-revealjs/bayeoptloop-1.png" width="960"></p>
</div>
<div class="cell-output cell-output-stdout quarto-layout-cell" style="flex-basis: 7.7%;justify-content: flex-start;">
<pre><code>[1] 44</code></pre>
</div>
<div class="quarto-layout-cell" style="flex-basis: 46.2%;justify-content: center;">
<p><img data-src="05-sp_files/figure-revealjs/bayeoptloop-2.png" width="960"></p>
</div>
</div>
</div>
</section>
<section id="run-optimisation-2" class="slide level2">
<h2>Run Optimisation</h2>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a></a><span class="fu">nextsample</span>(); <span class="co"># 57</span></span>
<span id="cb32-2"><a></a><span class="fu">updgp</span>(<span class="dv">57</span>, <span class="sc">-</span><span class="fl">7.1</span>);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell quarto-layout-panel" data-layout="[[6,1,6], [6,1,6]]">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 46.2%;justify-content: center;">
<p><img data-src="05-sp_files/figure-revealjs/bayeoptloop1-1.png" width="960"></p>
</div>
<div class="cell-output cell-output-stdout quarto-layout-cell" style="flex-basis: 7.7%;justify-content: flex-start;">
<pre><code>[1] 57</code></pre>
</div>
<div class="quarto-layout-cell" style="flex-basis: 46.2%;justify-content: center;">
<p><img data-src="05-sp_files/figure-revealjs/bayeoptloop1-2.png" width="960"></p>
</div>
</div>
</div>
</section>
<section id="run-optimisation-3" class="slide level2">
<h2>Run Optimisation</h2>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a></a><span class="fu">nextsample</span>(); <span class="co"># 45</span></span>
<span id="cb34-2"><a></a><span class="fu">updgp</span>(<span class="dv">45</span>, <span class="sc">-</span><span class="fl">8.5</span>);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell quarto-layout-panel" data-layout="[[6,1,6], [6,1,6]]">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 46.2%;justify-content: center;">
<p><img data-src="05-sp_files/figure-revealjs/bayeoptloop2-1.png" width="960"></p>
</div>
<div class="cell-output cell-output-stdout quarto-layout-cell" style="flex-basis: 7.7%;justify-content: flex-start;">
<pre><code>[1] 45</code></pre>
</div>
<div class="quarto-layout-cell" style="flex-basis: 46.2%;justify-content: center;">
<p><img data-src="05-sp_files/figure-revealjs/bayeoptloop2-2.png" width="960"></p>
</div>
</div>
</div>
</section>
<section id="run-optimisation-4" class="slide level2">
<h2>Run Optimisation</h2>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a></a><span class="fu">nextsample</span>(); <span class="co"># 100</span></span>
<span id="cb36-2"><a></a><span class="fu">updgp</span>(<span class="dv">100</span>, <span class="sc">-</span><span class="fl">3.3</span>);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell quarto-layout-panel" data-layout="[[6,1,6], [6,1,6]]">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 46.2%;justify-content: center;">
<p><img data-src="05-sp_files/figure-revealjs/bayeoptloop3-1.png" width="960"></p>
</div>
<div class="cell-output cell-output-stdout quarto-layout-cell" style="flex-basis: 7.7%;justify-content: flex-start;">
<pre><code>[1] 100</code></pre>
</div>
<div class="quarto-layout-cell" style="flex-basis: 46.2%;justify-content: center;">
<p><img data-src="05-sp_files/figure-revealjs/bayeoptloop3-2.png" width="960"></p>
</div>
</div>
</div>
</section>
<section id="run-optimisation-stop" class="slide level2">
<h2>Run Optimisation: Stop</h2>
<p>If we run <code>nextsample</code> one more time, we get 47, close to our current best of 45. Further, the model is confident at this location. It means that we can stop the algorithm and “declare a victory”</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a></a><span class="fu">nextsample</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>

<div class="cell-output cell-output-stdout">
<pre><code>[1] 47</code></pre>
</div>
</div>


<img data-src="05-sp_files/figure-revealjs/stopbayes-1.png" width="960" class="r-stretch"></section></section>
    </div>
  <div class="quarto-auto-generated-content" style="display: none;">
<div class="footer footer-default">

</div>
</div></div>

  <script>window.backupDefine = window.define; window.define = undefined;</script>
  <script src="site_libs/revealjs/dist/reveal.js"></script>
  <!-- reveal.js plugins -->
  <script src="site_libs/revealjs/plugin/quarto-line-highlight/line-highlight.js"></script>
  <script src="site_libs/revealjs/plugin/pdf-export/pdfexport.js"></script>
  <script src="site_libs/revealjs/plugin/reveal-menu/menu.js"></script>
  <script src="site_libs/revealjs/plugin/reveal-menu/quarto-menu.js"></script>
  <script src="site_libs/revealjs/plugin/reveal-chalkboard/plugin.js"></script>
  <script src="site_libs/revealjs/plugin/quarto-support/support.js"></script>
  

  <script src="site_libs/revealjs/plugin/notes/notes.js"></script>
  <script src="site_libs/revealjs/plugin/search/search.js"></script>
  <script src="site_libs/revealjs/plugin/zoom/zoom.js"></script>
  <script src="site_libs/revealjs/plugin/math/math.js"></script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script>

  <script>

      // Full list of configuration options available at:
      // https://revealjs.com/config/
      Reveal.initialize({
'controlsAuto': true,
'previewLinksAuto': false,
'pdfSeparateFragments': false,
'autoAnimateEasing': "ease",
'autoAnimateDuration': 1,
'autoAnimateUnmatched': true,
'jumpToSlide': true,
'menu': {"side":"left","useTextContentForMissingTitles":true,"markers":false,"loadIcons":false,"custom":[{"title":"Tools","icon":"<i class=\"fas fa-gear\"></i>","content":"<ul class=\"slide-menu-items\">\n<li class=\"slide-tool-item active\" data-item=\"0\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.fullscreen(event)\"><kbd>f</kbd> Fullscreen</a></li>\n<li class=\"slide-tool-item\" data-item=\"1\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.speakerMode(event)\"><kbd>s</kbd> Speaker View</a></li>\n<li class=\"slide-tool-item\" data-item=\"2\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.overview(event)\"><kbd>o</kbd> Slide Overview</a></li>\n<li class=\"slide-tool-item\" data-item=\"3\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.togglePdfExport(event)\"><kbd>e</kbd> PDF Export Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"4\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleScrollView(event)\"><kbd>r</kbd> Scroll View Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"5\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleChalkboard(event)\"><kbd>b</kbd> Toggle Chalkboard</a></li>\n<li class=\"slide-tool-item\" data-item=\"6\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleNotesCanvas(event)\"><kbd>c</kbd> Toggle Notes Canvas</a></li>\n<li class=\"slide-tool-item\" data-item=\"7\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.downloadDrawings(event)\"><kbd>d</kbd> Download Drawings</a></li>\n<li class=\"slide-tool-item\" data-item=\"8\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.keyboardHelp(event)\"><kbd>?</kbd> Keyboard Help</a></li>\n</ul>"}],"openButton":true},
'chalkboard': {"buttons":true},
'smaller': false,
 
        // Display controls in the bottom right corner
        controls: false,

        // Help the user learn the controls by providing hints, for example by
        // bouncing the down arrow when they first encounter a vertical slide
        controlsTutorial: false,

        // Determines where controls appear, "edges" or "bottom-right"
        controlsLayout: 'edges',

        // Visibility rule for backwards navigation arrows; "faded", "hidden"
        // or "visible"
        controlsBackArrows: 'faded',

        // Display a presentation progress bar
        progress: true,

        // Display the page number of the current slide
        slideNumber: 'c/t',

        // 'all', 'print', or 'speaker'
        showSlideNumber: 'all',

        // Add the current slide number to the URL hash so that reloading the
        // page/copying the URL will return you to the same slide
        hash: true,

        // Start with 1 for the hash rather than 0
        hashOneBasedIndex: false,

        // Flags if we should monitor the hash and change slides accordingly
        respondToHashChanges: true,

        // Push each slide change to the browser history
        history: true,

        // Enable keyboard shortcuts for navigation
        keyboard: true,

        // Enable the slide overview mode
        overview: true,

        // Disables the default reveal.js slide layout (scaling and centering)
        // so that you can use custom CSS layout
        disableLayout: false,

        // Vertical centering of slides
        center: false,

        // Enables touch navigation on devices with touch input
        touch: true,

        // Loop the presentation
        loop: false,

        // Change the presentation direction to be RTL
        rtl: false,

        // see https://revealjs.com/vertical-slides/#navigation-mode
        navigationMode: 'linear',

        // Randomizes the order of slides each time the presentation loads
        shuffle: false,

        // Turns fragments on and off globally
        fragments: true,

        // Flags whether to include the current fragment in the URL,
        // so that reloading brings you to the same fragment position
        fragmentInURL: false,

        // Flags if the presentation is running in an embedded mode,
        // i.e. contained within a limited portion of the screen
        embedded: false,

        // Flags if we should show a help overlay when the questionmark
        // key is pressed
        help: true,

        // Flags if it should be possible to pause the presentation (blackout)
        pause: true,

        // Flags if speaker notes should be visible to all viewers
        showNotes: false,

        // Global override for autoplaying embedded media (null/true/false)
        autoPlayMedia: null,

        // Global override for preloading lazy-loaded iframes (null/true/false)
        preloadIframes: null,

        // Number of milliseconds between automatically proceeding to the
        // next slide, disabled when set to 0, this value can be overwritten
        // by using a data-autoslide attribute on your slides
        autoSlide: 0,

        // Stop auto-sliding after user input
        autoSlideStoppable: true,

        // Use this method for navigation when auto-sliding
        autoSlideMethod: null,

        // Specify the average time in seconds that you think you will spend
        // presenting each slide. This is used to show a pacing timer in the
        // speaker view
        defaultTiming: null,

        // Enable slide navigation via mouse wheel
        mouseWheel: false,

        // The display mode that will be used to show slides
        display: 'block',

        // Hide cursor if inactive
        hideInactiveCursor: true,

        // Time before the cursor is hidden (in ms)
        hideCursorTime: 5000,

        // Opens links in an iframe preview overlay
        previewLinks: false,

        // Transition style (none/fade/slide/convex/concave/zoom)
        transition: 'none',

        // Transition speed (default/fast/slow)
        transitionSpeed: 'default',

        // Transition style for full page slide backgrounds
        // (none/fade/slide/convex/concave/zoom)
        backgroundTransition: 'none',

        // Number of slides away from the current that are visible
        viewDistance: 3,

        // Number of slides away from the current that are visible on mobile
        // devices. It is advisable to set this to a lower number than
        // viewDistance in order to save resources.
        mobileViewDistance: 2,

        // The "normal" size of the presentation, aspect ratio will be preserved
        // when the presentation is scaled to fit different resolutions. Can be
        // specified using percentage units.
        width: 1226,

        height: 920,

        // Factor of the display size that should remain empty around the content
        margin: 0.1,

        math: {
          mathjax: 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js',
          config: 'TeX-AMS_HTML-full',
          tex2jax: {
            inlineMath: [['\\(','\\)']],
            displayMath: [['\\[','\\]']],
            balanceBraces: true,
            processEscapes: false,
            processRefs: true,
            processEnvironments: true,
            preview: 'TeX',
            skipTags: ['script','noscript','style','textarea','pre','code'],
            ignoreClass: 'tex2jax_ignore',
            processClass: 'tex2jax_process'
          },
        },

        // reveal.js plugins
        plugins: [QuartoLineHighlight, PdfExport, RevealMenu, RevealChalkboard, QuartoSupport,

          RevealMath,
          RevealNotes,
          RevealSearch,
          RevealZoom
        ]
      });
    </script>
    
    <script>
      // htmlwidgets need to know to resize themselves when slides are shown/hidden.
      // Fire the "slideenter" event (handled by htmlwidgets.js) when the current
      // slide changes (different for each slide format).
      (function () {
        // dispatch for htmlwidgets
        function fireSlideEnter() {
          const event = window.document.createEvent("Event");
          event.initEvent("slideenter", true, true);
          window.document.dispatchEvent(event);
        }

        function fireSlideChanged(previousSlide, currentSlide) {
          fireSlideEnter();

          // dispatch for shiny
          if (window.jQuery) {
            if (previousSlide) {
              window.jQuery(previousSlide).trigger("hidden");
            }
            if (currentSlide) {
              window.jQuery(currentSlide).trigger("shown");
            }
          }
        }

        // hookup for slidy
        if (window.w3c_slidy) {
          window.w3c_slidy.add_observer(function (slide_num) {
            // slide_num starts at position 1
            fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);
          });
        }

      })();
    </script>

    <script id="quarto-html-after-body" type="application/javascript">
    window.document.addEventListener("DOMContentLoaded", function (event) {
      const toggleBodyColorMode = (bsSheetEl) => {
        const mode = bsSheetEl.getAttribute("data-mode");
        const bodyEl = window.document.querySelector("body");
        if (mode === "dark") {
          bodyEl.classList.add("quarto-dark");
          bodyEl.classList.remove("quarto-light");
        } else {
          bodyEl.classList.add("quarto-light");
          bodyEl.classList.remove("quarto-dark");
        }
      }
      const toggleBodyColorPrimary = () => {
        const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
        if (bsSheetEl) {
          toggleBodyColorMode(bsSheetEl);
        }
      }
      toggleBodyColorPrimary();  
      const tabsets =  window.document.querySelectorAll(".panel-tabset-tabby")
      tabsets.forEach(function(tabset) {
        const tabby = new Tabby('#' + tabset.id);
      });
      const isCodeAnnotation = (el) => {
        for (const clz of el.classList) {
          if (clz.startsWith('code-annotation-')) {                     
            return true;
          }
        }
        return false;
      }
      const onCopySuccess = function(e) {
        // button target
        const button = e.trigger;
        // don't keep focus
        button.blur();
        // flash "checked"
        button.classList.add('code-copy-button-checked');
        var currentTitle = button.getAttribute("title");
        button.setAttribute("title", "Copied!");
        let tooltip;
        if (window.bootstrap) {
          button.setAttribute("data-bs-toggle", "tooltip");
          button.setAttribute("data-bs-placement", "left");
          button.setAttribute("data-bs-title", "Copied!");
          tooltip = new bootstrap.Tooltip(button, 
            { trigger: "manual", 
              customClass: "code-copy-button-tooltip",
              offset: [0, -8]});
          tooltip.show();    
        }
        setTimeout(function() {
          if (tooltip) {
            tooltip.hide();
            button.removeAttribute("data-bs-title");
            button.removeAttribute("data-bs-toggle");
            button.removeAttribute("data-bs-placement");
          }
          button.setAttribute("title", currentTitle);
          button.classList.remove('code-copy-button-checked');
        }, 1000);
        // clear code selection
        e.clearSelection();
      }
      const getTextToCopy = function(trigger) {
          const codeEl = trigger.previousElementSibling.cloneNode(true);
          for (const childEl of codeEl.children) {
            if (isCodeAnnotation(childEl)) {
              childEl.remove();
            }
          }
          return codeEl.innerText;
      }
      const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
        text: getTextToCopy
      });
      clipboard.on('success', onCopySuccess);
      if (window.document.getElementById('quarto-embedded-source-code-modal')) {
        const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
          text: getTextToCopy,
          container: window.document.getElementById('quarto-embedded-source-code-modal')
        });
        clipboardModal.on('success', onCopySuccess);
      }
        var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
        var mailtoRegex = new RegExp(/^mailto:/);
          var filterRegex = new RegExp('/' + window.location.host + '/');
        var isInternal = (href) => {
            return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
        }
        // Inspect non-navigation links and adorn them if external
     	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
        for (var i=0; i<links.length; i++) {
          const link = links[i];
          if (!isInternal(link.href)) {
            // undo the damage that might have been done by quarto-nav.js in the case of
            // links that we want to consider external
            if (link.dataset.originalHref !== undefined) {
              link.href = link.dataset.originalHref;
            }
          }
        }
      function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
        const config = {
          allowHTML: true,
          maxWidth: 500,
          delay: 100,
          arrow: false,
          appendTo: function(el) {
              return el.closest('section.slide') || el.parentElement;
          },
          interactive: true,
          interactiveBorder: 10,
          theme: 'light-border',
          placement: 'bottom-start',
        };
        if (contentFn) {
          config.content = contentFn;
        }
        if (onTriggerFn) {
          config.onTrigger = onTriggerFn;
        }
        if (onUntriggerFn) {
          config.onUntrigger = onUntriggerFn;
        }
          config['offset'] = [0,0];
          config['maxWidth'] = 700;
        window.tippy(el, config); 
      }
      const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
      for (var i=0; i<noterefs.length; i++) {
        const ref = noterefs[i];
        tippyHover(ref, function() {
          // use id or data attribute instead here
          let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
          try { href = new URL(href).hash; } catch {}
          const id = href.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note) {
            return note.innerHTML;
          } else {
            return "";
          }
        });
      }
      const findCites = (el) => {
        const parentEl = el.parentElement;
        if (parentEl) {
          const cites = parentEl.dataset.cites;
          if (cites) {
            return {
              el,
              cites: cites.split(' ')
            };
          } else {
            return findCites(el.parentElement)
          }
        } else {
          return undefined;
        }
      };
      var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
      for (var i=0; i<bibliorefs.length; i++) {
        const ref = bibliorefs[i];
        const citeInfo = findCites(ref);
        if (citeInfo) {
          tippyHover(citeInfo.el, function() {
            var popup = window.document.createElement('div');
            citeInfo.cites.forEach(function(cite) {
              var citeDiv = window.document.createElement('div');
              citeDiv.classList.add('hanging-indent');
              citeDiv.classList.add('csl-entry');
              var biblioDiv = window.document.getElementById('ref-' + cite);
              if (biblioDiv) {
                citeDiv.innerHTML = biblioDiv.innerHTML;
              }
              popup.appendChild(citeDiv);
            });
            return popup.innerHTML;
          });
        }
      }
    });
    </script>
    

</body></html>